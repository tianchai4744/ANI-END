<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANI-END - หน้าแรก</title>
    
    <link rel="stylesheet" href="./style.css">

    <style>
        /* --- Styles --- */
        /* ซ่อนปุ่ม Swiper เดิม */
        .swiper-button-next, .swiper-button-prev { display: none !important; }
        
        /* Pagination Styling */
        .swiper-pagination-bullet { 
            background: #fff !important; opacity: 0.4 !important; 
            width: 8px !important; height: 8px !important; transition: all 0.3s !important;
        }
        .swiper-pagination-bullet-active { 
            background: #00b87c !important; opacity: 1 !important; 
            width: 24px !important; border-radius: 4px !important;
        }
        
        /* Ken Burns Effect */
        @keyframes ken-burns {
            0% { transform: scale(1); }
            100% { transform: scale(1.15); }
        }
        .animate-ken-burns {
            animation: ken-burns 15s ease-out infinite alternate;
            will-change: transform;
        }

        /* Slide Up Animation */
        @keyframes slide-up-fade {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slide-up-fade 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        a { cursor: pointer; }
        .nav-link { transition: color 0.2s, background-color 0.2s; }
        .nav-link.active { color: #00b87c; } 
        #mobile-search-bar { display: none; }
        
        /* Custom Scrollbar for History */
        .custom-scrollbar-y::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar-y::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar-y::-webkit-scrollbar-track { background: transparent; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .skeleton { background-color: #374151; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; border-radius: 0.5rem; }
    </style>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="./favicon.ico">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
</head>
<body class="bg-black text-gray-100">

    <script type="module">
        import 'remixicon/fonts/remixicon.css';
        import 'swiper/css';
        import 'swiper/css/navigation';
        import 'swiper/css/pagination';

        import { onAuthStateChanged } from "firebase/auth";
        import { onSnapshot, collection, query, limit, orderBy, where, getDocs } from "firebase/firestore";

        import { db, auth, appId } from "./js/config/db-config.js";
        import { setupSearchSystem } from "./js/modules/search.js";
        import { loadNavbar } from "./js/modules/navbar.js";
        
        import { renderHeroBanner, renderHeroSkeleton } from "./js/modules/hero-banner.js";
        import { renderTop10Section } from "./js/modules/top10.js";
        // Import ฟังก์ชันเดิมแต่เป็นเวอร์ชันปรับปรุงแล้ว
        import { renderHistorySectionHTML } from "./js/modules/history-section.js";
        
        import { renderRecommendedSection } from "./js/modules/recommended.js";
        import { renderThaiDubSection } from "./js/modules/thai-dub.js";
        import { renderLatestUpdatesSection } from "./js/modules/latest-updates.js";

        import { initGlobalErrorLogging } from "./js/modules/logger.js";
        import { observeImages } from "./js/utils/tools.js";

        initGlobalErrorLogging();

        let userId;
        let historyItems = []; 
        let allBanners = []; 
        let historyUnsubscribe = null; 
        let isSearchInitialized = false; 
        
        let top30Shows = [];
        let thaiDubShows = [];
        let latestShows = [];
        
        let sectionsContainer;
        
        function initializeFirebase() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;

                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('search')) {
                        const query = urlParams.get('search');
                        if(query) {
                            window.location.replace(`pages/grid.html?search=${encodeURIComponent(query)}`);
                            return; 
                        }
                    }

                    if (!isSearchInitialized) {
                        setupSearchSystem(historyItems);
                        isSearchInitialized = true;
                    }
                    setupHistoryListener();
                } else {
                    userId = null;
                    historyItems = [];
                     if (!isSearchInitialized) {
                        setupSearchSystem([]);
                        isSearchInitialized = true;
                    }
                    updateHistorySectionOnly();
                }
                
                await setupOptimizedDataFetch(); 
            });
        }

        function getCollectionRef(collectionName) {
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        }
        
        function getHistoryCollectionRef() {
             return collection(db, `artifacts/${appId}/users/${userId}/viewHistory`);
        }

        function renderSkeletons() {
            renderHeroSkeleton('hero-swiper');
            if (sectionsContainer) {
                let html = '';
                for(let i=0; i<3; i++) {
                    html += `
                        <div class="mb-8">
                            <div class="h-8 w-48 bg-gray-800 skeleton mb-4 rounded"></div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                ${Array(6).fill(0).map(() => `<div class="aspect-[2/3] bg-gray-800 skeleton rounded-lg"></div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                sectionsContainer.innerHTML = html;
            }
        }

        async function setupOptimizedDataFetch() {
            try {
                if (allBanners.length === 0 && top30Shows.length === 0) renderSkeletons();

                const showsRef = getCollectionRef("shows");
                const bannerRef = getCollectionRef("banners");

                const top30Query = query(showsRef, orderBy("viewCount", "desc"), limit(30));
                const thaiDubQuery = query(showsRef, where("tags", "array-contains", "อนิเมะพากย์ไทย"), limit(15));
                const latestQuery = query(showsRef, orderBy("latestEpisodeUpdateAt", "desc"), limit(15));
                const bannerQuery = query(bannerRef, orderBy("updatedAt", "desc"), limit(10));

                const results = await Promise.allSettled([
                    getDocs(top30Query), 
                    getDocs(thaiDubQuery), 
                    getDocs(latestQuery), 
                    getDocs(bannerQuery)
                ]);

                const getData = (result, name) => {
                    if (result.status === 'fulfilled') {
                        return result.value.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                        console.warn(`⚠️ Failed to load ${name}:`, result.reason);
                        return [];
                    }
                };

                top30Shows = getData(results[0], 'Top 30');
                thaiDubShows = getData(results[1], 'Thai Dub');
                latestShows = getData(results[2], 'Latest Updates');
                allBanners = getData(results[3], 'Banners');

                renderHeroBanner('hero-swiper', allBanners, historyItems, userId);
                renderOptimizedSections(top30Shows, thaiDubShows, latestShows);

            } catch (error) {
                console.error("Critical Error fetching data:", error);
                if(sectionsContainer) sectionsContainer.innerHTML = `<p class="text-center text-red-500 py-10">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</p>`;
            }
        }
        
        // ฟังก์ชัน Render ประวัติ (ปรับปรุงให้รองรับ Scroll)
        function renderHistorySection() {
            const htmlContent = renderHistorySectionHTML(historyItems, userId);
            
            const container = document.getElementById('main-history-container');
            if (container) {
                container.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="flex-1 overflow-y-auto custom-scrollbar-y pr-1">
                            ${htmlContent}
                        </div>
                    </div>
                `;
            }
        }

        function updateHistorySectionOnly() {
            if (allBanners.length > 0) renderHeroBanner('hero-swiper', allBanners, historyItems, userId);
            renderHistorySection();
        }

        function setupHistoryListener() {
            if (!userId) return;
            if (historyUnsubscribe) historyUnsubscribe();

            const historyQuery = query(getHistoryCollectionRef(), orderBy("watchedAt", "desc"), limit(10));
            historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                historyItems.length = 0; 
                snapshot.forEach((doc) => {
                    historyItems.push({ id: doc.id, ...doc.data() });
                });
                updateHistorySectionOnly();
            });
        }

        function renderOptimizedSections(top30Shows, thaiDubShows, latestShows) {
            if (!sectionsContainer) return;
            sectionsContainer.innerHTML = ''; 

            // 1. Top 10 (Full Width)
            const top10Element = renderTop10Section(top30Shows, historyItems);
            if (top10Element) {
                sectionsContainer.appendChild(top10Element);
            }
            
            // 2. Recommended
            const recommendedEl = renderRecommendedSection(top30Shows, historyItems);
            if (recommendedEl) sectionsContainer.appendChild(recommendedEl);

            // 3. Thai Dub
            const thaiDubEl = renderThaiDubSection(thaiDubShows, historyItems);
            if (thaiDubEl) sectionsContainer.appendChild(thaiDubEl);

            // 4. Latest
            const latestEl = renderLatestUpdatesSection(latestShows, historyItems);
            if (latestEl) sectionsContainer.appendChild(latestEl);
            
            if(top30Shows.length === 0 && latestShows.length === 0) { 
                sectionsContainer.innerHTML = `<p class="text-center text-gray-400 py-10">ไม่สามารถโหลดข้อมูลได้ในขณะนี้</p>`;
            }

            observeImages(sectionsContainer);
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadNavbar('.');
            sectionsContainer = document.getElementById('sections-container');
            initializeFirebase(); 
        });
    </script>
    
    <div id="navbar-placeholder"></div>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div id="home-view">
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-12">
                
                <section id="hero-banner-container" class="lg:col-span-3 relative h-[240px] sm:h-[360px] lg:h-[480px] rounded-2xl overflow-hidden bg-gray-900 shadow-2xl group ring-1 ring-gray-800">
                    <div id="hero-swiper" class="swiper w-full h-full">
                        <div class="swiper-wrapper"></div>
                        <div class="swiper-pagination"></div>
                        </div>
                </section>

                <section id="main-history-container" class="lg:col-span-1 h-auto lg:h-[480px] bg-gray-900/80 backdrop-blur-md rounded-2xl p-4 border border-gray-800 shadow-xl flex flex-col overflow-hidden">
                    <div class="h-full flex flex-col animate-pulse">
                        <div class="h-8 w-1/2 bg-gray-800 rounded mb-4"></div>
                        <div class="flex-1 space-y-3">
                            <div class="h-16 bg-gray-800 rounded-lg"></div>
                            <div class="h-16 bg-gray-800 rounded-lg"></div>
                            <div class="h-16 bg-gray-800 rounded-lg"></div>
                        </div>
                    </div>
                </section>
            </div>

            <div id="sections-container" class="w-full">
                <div class="animate-pulse">
                    <div class="h-6 w-32 bg-gray-800 rounded mb-4"></div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4">
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 border-t border-gray-800 mt-8 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm mb-2">© 2024 ANI-END. All rights reserved.</p>
            <div class="flex justify-center gap-4 mt-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="ri-facebook-fill text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="ri-twitter-x-fill text-xl"></i></a>
            </div>
        </div>
    </footer>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js');
        });
      }
    </script>
</body>
</html>
