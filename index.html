<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANI-END - หน้าแรก</title>
    
    <link rel="stylesheet" href="./style.css">

    <style>
        /* CSS เฉพาะหน้าที่ยังคงไว้ */
        .swiper-button-next, .swiper-button-prev { 
            color: #ffffff; 
            background-color: rgba(0,0,0,0.5); 
            width: 44px; height: 44px; border-radius: 50%;
            cursor: pointer; backdrop-filter: blur(2px); transition: all 0.2s; z-index: 20;
        }
        .swiper-button-next:hover, .swiper-button-prev:hover {
            background-color: rgba(0,184,124,0.9); transform: scale(1.1);
        }
        .swiper-button-next:after, .swiper-button-prev:after { font-size: 20px; font-weight: 900; }
        .swiper-pagination-bullet { background: #fff; opacity: 0.5; transition: all 0.3s; }
        .swiper-pagination-bullet-active { background: #00b87c; opacity: 1; width: 20px; border-radius: 4px; }
        
        a { cursor: pointer; }
        .nav-link { transition: color 0.2s, background-color 0.2s; }
        .nav-link.active { color: #00b87c; } 
        #mobile-search-bar { display: none; }
        
        .search-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
            background-color: #1f2937; border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); max-height: 400px; overflow-y: auto;
        }
        .search-dropdown-item:hover { background-color: #374151; }
     
        .history-card {
            display: flex; align-items: center; gap: 8px; padding: 6px; 
            border-radius: 8px; background-color: #1f2937; transition: background-color 0.15s;
        }
        .history-card:hover { background-color: #374151; }
        .history-thumb { width: 48px; height: 64px; aspect-ratio: 3/4; object-fit: cover; flex-shrink: 0; border-radius: 4px; }
        
        .banner-overlay {
            position: absolute; bottom: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); pointer-events: none;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .skeleton { background-color: #374151; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; border-radius: 0.5rem; }
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="/favicon.ico">
</head>
<body class="bg-black text-gray-100">

    <script type="module">
        import 'remixicon/fonts/remixicon.css';
        import 'swiper/css';
        import 'swiper/css/navigation';
        import 'swiper/css/pagination';

        import { signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { onSnapshot, collection, query, limit, orderBy, where, getDocs } from "firebase/firestore";

        import { db, auth, appId } from "./js/config/db-config.js";
        import { setupSearchSystem } from "./js/modules/search.js";
        import { loadNavbar } from "./js/modules/navbar.js";
        
        // --- Imported Modules ---
        import { renderHeroBanner, renderHeroSkeleton } from "./js/modules/hero-banner.js";
        import { renderTop10Section } from "./js/modules/top10.js";
        import { renderHistorySectionHTML } from "./js/modules/history-section.js";
        
        // Section Modules
        import { renderRecommendedSection } from "./js/modules/recommended.js";
        import { renderThaiDubSection } from "./js/modules/thai-dub.js";
        import { renderLatestUpdatesSection } from "./js/modules/latest-updates.js";

        import { initGlobalErrorLogging } from "./js/modules/logger.js";
        import { observeImages } from "./js/utils/tools.js";

        // เริ่มต้นระบบ Log ทันที
        initGlobalErrorLogging();

        let userId;
        let historyItems = []; 
        let allBanners = []; 
        let historyUnsubscribe = null; 
        let isSearchInitialized = false; 
        
        let top30Shows = [];
        let thaiDubShows = [];
        let latestShows = [];
        
        let sectionsContainer;
        
        function initializeFirebase() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;

                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('search')) {
                        const query = urlParams.get('search');
                        if(query) {
                            window.location.replace(`pages/grid.html?search=${encodeURIComponent(query)}`);
                            return; 
                        }
                    }

                    if (!isSearchInitialized) {
                        const input = document.getElementById('search-input');
                        if (input) {
                            setupSearchSystem(historyItems);
                            isSearchInitialized = true;
                        } else {
                            setTimeout(() => {
                                if(!isSearchInitialized) {
                                    setupSearchSystem(historyItems);
                                    isSearchInitialized = true;
                                }
                            }, 500);
                        }
                    }
                    setupHistoryListener();
                } else {
                    userId = null;
                    historyItems = [];
                     if (!isSearchInitialized) {
                        setupSearchSystem([]);
                        isSearchInitialized = true;
                    }
                    updateHistorySectionOnly();
                }
                
                await setupOptimizedDataFetch(); 
            });
        }

        function getCollectionRef(collectionName) {
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        }
        
        function getHistoryCollectionRef() {
             return collection(db, `artifacts/${appId}/users/${userId}/viewHistory`);
        }

        function renderSkeletons() {
            renderHeroSkeleton('hero-swiper');
            if (sectionsContainer) {
                let html = '';
                for(let i=0; i<3; i++) {
                    html += `
                        <div class="mb-8">
                            <div class="h-8 w-48 bg-gray-800 skeleton mb-4 rounded"></div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                ${Array(6).fill(0).map(() => `<div class="aspect-[2/3] bg-gray-800 skeleton rounded-lg"></div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                sectionsContainer.innerHTML = html;
            }
        }

        async function setupOptimizedDataFetch() {
            try {
                if (allBanners.length === 0 && top30Shows.length === 0) renderSkeletons();

                const showsRef = getCollectionRef("shows");
                const bannerRef = getCollectionRef("banners");

                const top30Query = query(showsRef, orderBy("viewCount", "desc"), limit(30));
                const thaiDubQuery = query(showsRef, where("tags", "array-contains", "อนิเมะพากย์ไทย"), limit(15));
                const latestQuery = query(showsRef, orderBy("latestEpisodeUpdateAt", "desc"), limit(15));
                const bannerQuery = query(bannerRef, orderBy("updatedAt", "desc"), limit(10));

                // ✅ ใช้วิธี Promise.allSettled เพื่อความเสถียร (อันไหนพัง อันอื่นยังรอด)
                const results = await Promise.allSettled([
                    getDocs(top30Query), 
                    getDocs(thaiDubQuery), 
                    getDocs(latestQuery), 
                    getDocs(bannerQuery)
                ]);

                // Helper: ดึงข้อมูลถ้าสำเร็จ ถ้าไม่สำเร็จให้คืนค่า Array ว่าง
                const getData = (result, name) => {
                    if (result.status === 'fulfilled') {
                        return result.value.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                        console.warn(`⚠️ Failed to load ${name}:`, result.reason);
                        return [];
                    }
                };

                top30Shows = getData(results[0], 'Top 30');
                thaiDubShows = getData(results[1], 'Thai Dub');
                latestShows = getData(results[2], 'Latest Updates');
                allBanners = getData(results[3], 'Banners');

                // Render UI (แม้ข้อมูลจะมาไม่ครบ ก็ยังแสดงส่วนที่มาครบได้)
                renderHeroBanner('hero-swiper', allBanners, historyItems, userId);
                renderOptimizedSections(top30Shows, thaiDubShows, latestShows);

            } catch (error) {
                console.error("Critical Error fetching data:", error);
                if(sectionsContainer) sectionsContainer.innerHTML = `<p class="text-center text-red-500 py-10">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</p>`;
            }
        }
        
        function renderHistorySection() {
            const htmlContent = renderHistorySectionHTML(historyItems, userId);
            
            const mobileContainer = document.getElementById('history-mobile-container');
            if (mobileContainer) mobileContainer.innerHTML = htmlContent;
            
            const desktopContainer = document.getElementById('history-desktop-container');
            if (desktopContainer) desktopContainer.innerHTML = htmlContent;
        }

        function updateHistorySectionOnly() {
            if (allBanners.length > 0) renderHeroBanner('hero-swiper', allBanners, historyItems, userId);
            renderHistorySection();
        }

        function setupHistoryListener() {
            if (!userId) return;
            if (historyUnsubscribe) historyUnsubscribe();

            const historyQuery = query(getHistoryCollectionRef(), orderBy("watchedAt", "desc"), limit(5));
            historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                historyItems.length = 0; 
                snapshot.forEach((doc) => {
                    historyItems.push({ id: doc.id, ...doc.data() });
                });
                updateHistorySectionOnly();
            });
        }

        function renderOptimizedSections(top30Shows, thaiDubShows, latestShows) {
            if (!sectionsContainer) return;
            sectionsContainer.innerHTML = ''; 
            
            const historyMobileSection = document.createElement('section');
            historyMobileSection.className = 'block lg:hidden w-full mb-8';
            historyMobileSection.id = 'history-mobile-container';
            historyMobileSection.innerHTML = renderHistorySectionHTML(historyItems, userId);
            sectionsContainer.appendChild(historyMobileSection);

            const dualGridContainer = document.createElement('div');
            dualGridContainer.className = 'flex flex-wrap lg:flex-nowrap gap-6 mb-8'; 
            
            const top10Element = renderTop10Section(top30Shows, historyItems);
            if (top10Element) dualGridContainer.appendChild(top10Element);
            
            const historyDesktopSection = document.createElement('section');
            historyDesktopSection.className = 'hidden lg:block w-full lg:w-1/3 flex-shrink-0 bg-gray-900 p-4 rounded-lg order-2 lg:order-2'; 
            historyDesktopSection.id = 'history-desktop-container';
            historyDesktopSection.innerHTML = renderHistorySectionHTML(historyItems, userId);
            dualGridContainer.appendChild(historyDesktopSection);
            
            sectionsContainer.appendChild(dualGridContainer);
            
            const recommendedEl = renderRecommendedSection(top30Shows, historyItems);
            if (recommendedEl) sectionsContainer.appendChild(recommendedEl);

            const thaiDubEl = renderThaiDubSection(thaiDubShows, historyItems);
            if (thaiDubEl) sectionsContainer.appendChild(thaiDubEl);

            const latestEl = renderLatestUpdatesSection(latestShows, historyItems);
            if (latestEl) sectionsContainer.appendChild(latestEl);
            
            if(top30Shows.length === 0 && latestShows.length === 0) { 
                sectionsContainer.innerHTML = `<p class="text-center text-gray-400 py-10">ไม่สามารถโหลดข้อมูลได้ในขณะนี้</p>`;
            }

            // Lazy Load Observer
            observeImages(sectionsContainer);
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadNavbar('.');
            sectionsContainer = document.getElementById('sections-container');
            initializeFirebase(); 
        });
    </script>
    
    <div id="navbar-placeholder"></div>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div id="home-view">
            <section id="hero-banner-container" class="relative aspect-[10/3] rounded-lg overflow-hidden mb-8 bg-gray-800 shadow-xl">
                <div id="hero-swiper" class="swiper w-full h-full">
                    <div class="swiper-wrapper"></div>
                    <div class="swiper-button-prev hidden md:flex items-center justify-center"></div>
                    <div class="swiper-button-next hidden md:flex items-center justify-center"></div>
                    <div class="swiper-pagination"></div>
                </div>
            </section>

            <div id="sections-container">
                <div class="animate-pulse">
                    <div class="h-6 w-32 bg-gray-800 rounded mb-4"></div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4">
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                        <div class="bg-gray-800 rounded-lg aspect-[2/3]"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 border-t border-gray-800 mt-8 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm mb-2">© 2024 ANI-END. All rights reserved.</p>
            <p class="text-gray-500 text-xs">เว็บไซต์นี้จัดทำขึ้นเพื่อการศึกษาและการเรียนรู้เท่านั้น</p>
            <div class="flex justify-center gap-4 mt-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="ri-facebook-fill text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="ri-twitter-x-fill text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="ri-discord-fill text-xl"></i></a>
            </div>
        </div>
    </footer>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js');
        });
      }
    </script>
</body>
</html>
