import{q as y,d as v,f as l,e as u,b as T,l as L,g as I,i as S,k as N,m as q,r as Q,n as H,w as b,h as K,p as O,u as J,j as X,s as Y,o as Z,a as tt}from"./db-config-CDOV0zmd.js";import{l as et}from"./navbar-BPKScrBx.js";import{g as nt,o as j,f as rt}from"./tools-BcGrSTdy.js";import{s as it}from"./search-Cjk7YTPU.js";import{c as st}from"./card-lo2QomBm.js";async function ot(t){if(!t)return[];try{const e=y(v(l,`artifacts/${u}/users/${t}/viewHistory`),T("watchedAt","desc"),L(50));return(await I(e)).docs.map(r=>({id:r.id,...r.data()}))}catch(e){return console.error("History load error:",e),[]}}async function at(t){const n=`last_view_${t}`,r=localStorage.getItem(n),i=Date.now();if(!(r&&i-parseInt(r)<18e5))try{const s=S(l,`artifacts/${u}/public/data/shows`,t);await Q(l,async a=>{const o=await a.get(s);if(!o.exists())return;const c=(o.data().viewCount||0)+1;a.update(s,{viewCount:c})}),localStorage.setItem(n,i.toString())}catch(s){console.warn("View count skipped:",s)}}async function ct(t,e,n){if(!(!t||!e||!n))try{const r=S(l,`artifacts/${u}/users/${t}/viewHistory`,e.id),i={showId:e.id,showTitle:e.title,showThumbnail:e.thumbnailUrl||"",lastWatchedEpisodeId:n.id,lastWatchedEpisodeTitle:n.title,lastWatchedEpisodeNumber:n.number,isCompleted:e.isCompleted===!0,latestEpisodeNumber:e.latestEpisodeNumber||0,watchedAt:N()};await q(r,i,{merge:!0})}catch(r){console.error("Save history error:",r)}}const d={currentShow:null,currentEpisode:null,user:null,history:[]};async function lt(t){if(!t)throw new Error("Missing Show ID");try{const e=S(l,`artifacts/${u}/public/data/shows`,t),n=await H(e);if(!n.exists())throw new Error("Show not found");return d.currentShow={id:n.id,...n.data()},d.currentShow}catch(e){throw console.error("Error fetching show:",e),e}}async function dt(t){if(!t)return null;try{const e=S(l,`artifacts/${u}/public/data/episodes`,t),n=await H(e);return n.exists()?{id:n.id,...n.data()}:null}catch(e){return console.error("Error fetching episode:",e),null}}function W(t,e){return!t||!d.currentShow?null:(d.currentEpisode=t,d.user=e,e&&ct(e.uid,d.currentShow,t),at(d.currentShow.id),ft(t.id),{embedHtml:ht(t),metaData:mt(d.currentShow,t),navStatus:pt(t.number,d.currentShow.latestEpisodeNumber),episodeId:t.id,episodeNumber:t.number,showId:d.currentShow.id})}async function ut(t,e){return!d.currentEpisode||!d.currentShow?null:await e.findNextPrevEpisode(d.currentEpisode.number,t,d.currentShow)}function ht(t){const e=t.videoUrl||t.embedCode;return e?nt(e):null}function mt(t,e){const n=e?` ตอนที่ ${e.number}`:"";return{title:`${t.title}${n} | ANI-END`,description:t.description||`ดูอนิเมะ ${t.title} ฟรี`,image:t.thumbnailUrl||"https://placehold.co/600x400",url:window.location.href,episodeTitle:`${t.title} - ${e.title||"ตอนที่ "+e.number}`}}function pt(t,e){const n=parseFloat(t)||1,r=parseFloat(e)||9999;return{canGoPrev:n>1,canGoNext:n<r}}function ft(t){if(t)try{const e=new URL(window.location.href);e.searchParams.set("ep_id",t),window.history.pushState({},"",e.href)}catch(e){console.warn("URL update failed:",e)}}const F=()=>({...d}),h={toggleLoading(t,e="กำลังโหลดข้อมูล..."){const n=document.getElementById("loading-player"),r=document.getElementById("player-content-wrapper");if(t){if(n)if(n.classList.remove("hidden"),!n.querySelector(".spinner"))n.innerHTML=`
                        <div class="spinner"></div>
                        <p class="mt-4 text-gray-400 animate-pulse">${e}</p>
                    `;else{const i=n.querySelector("p");i&&(i.textContent=e)}r&&r.classList.add("hidden")}else n&&n.classList.add("hidden"),r&&r.classList.remove("hidden")},renderShowInfo(t){if(!t)return;this._setText("show-title",t.title);const e=document.getElementById("show-description");e&&(e.textContent=t.description||"-",e.classList.add("line-clamp-2"))},checkDescriptionOverflow(){const t=document.getElementById("show-description"),e=document.getElementById("expand-desc-btn");!t||!e||(e.classList.add("hidden"),t.classList.add("line-clamp-2"),setTimeout(()=>{t.scrollHeight>t.clientHeight&&(e.classList.remove("hidden"),e.textContent="เพิ่มเติม",e.onclick=()=>{const n=t.classList.toggle("line-clamp-2");e.textContent=n?"เพิ่มเติม":"ย่อ"})},100))},renderPlayer(t){const e=document.getElementById("video-player-embed");e&&(t?e.innerHTML=t:this.renderErrorState("ไม่พบลิงก์วิดีโอ หรือไฟล์ถูกลบ"))},renderErrorState(t){const e=document.getElementById("video-player-embed");e&&(e.innerHTML=`
                <div class="flex flex-col items-center justify-center h-full text-gray-400 bg-gray-900">
                    <i class="ri-error-warning-line text-4xl mb-2"></i>
                    <p>${t}</p>
                </div>`)},updateMetaData(t){document.title=t.title,this._setText("show-title",t.episodeTitle);const e=(n,r)=>{let i=document.querySelector(`meta[property="${n}"]`)||document.querySelector(`meta[name="${n}"]`);i&&i.setAttribute("content",r)};e("og:title",t.title),e("og:description",t.description),e("og:image",t.image)},updateNavButtons({canGoPrev:t,canGoNext:e}){this._setBtnState("prev-episode-btn",t),this._setBtnState("next-episode-btn",e)},_setText(t,e){const n=document.getElementById(t);n&&(n.textContent=e)},_setBtnState(t,e){const n=document.getElementById(t);n&&(n.disabled=!e,n.classList.toggle("opacity-50",!e),n.classList.toggle("cursor-not-allowed",!e),n.classList.toggle("hover:bg-gray-700",!e))}},R={currentShowId:null,cache:[],init(t){this.currentShowId=t,this.cache=[]},async fetchByRange(t,e){if(!this.currentShowId)return[];try{const n=y(v(l,`artifacts/${u}/public/data/episodes`),b("showId","==",this.currentShowId),b("number",">=",t),b("number","<=",e),T("number","asc")),i=(await I(n)).docs.map(s=>({id:s.id,...s.data()}));return this.cache=[...this.cache,...i],i}catch(n){throw console.error("Service Error:",n),n}},async findSingleEpisode(t){const e=this.cache.find(i=>i.number===t);if(e)return e;const n=y(v(l,`artifacts/${u}/public/data/episodes`),b("showId","==",this.currentShowId),b("number","==",t),L(1)),r=await I(n);return r.empty?null:{id:r.docs[0].id,...r.docs[0].data()}}},w={container:null,rangeSelect:null,rangeContainer:null,activeEpisodeId:null,init(){this.container=document.getElementById("episode-list-container"),this.rangeContainer=document.getElementById("episode-range-container"),this.rangeSelect=document.getElementById("episode-range-select")},renderLoading(){this.container&&(this.container.innerHTML='<p class="text-gray-400 p-2 text-sm">กำลังโหลด...</p>')},renderError(){this.container&&(this.container.innerHTML='<p class="text-red-500 text-sm">โหลดข้อมูลล้มเหลว</p>')},renderEmpty(){this.container&&(this.container.innerHTML='<p class="text-gray-500 text-sm">ยังไม่มีตอน</p>')},setupRangeSelector(t,e){const n=t||0;if(n===0||!this.rangeContainer){this.rangeContainer&&this.rangeContainer.classList.add("hidden");return}const r=50,i=Math.ceil(n/r);let s="";for(let a=0;a<i;a++){const o=a*r+1,c=Math.min((a+1)*r,n);s+=`<option value="${o}-${c}">ตอนที่ ${o} - ${c}</option>`}i===0&&(s='<option value="">ไม่มีตอน</option>'),this.rangeSelect.innerHTML=s,this.rangeContainer.classList.remove("hidden"),this.rangeSelect.onchange=a=>{if(!a.target.value)return;const[o,c]=a.target.value.split("-").map(Number);e(o,c)}},updateRangeSelector(t){if(this.rangeSelect)for(let e of this.rangeSelect.options){const[n,r]=e.value.split("-").map(Number);if(t>=n&&t<=r){this.rangeSelect.value!==e.value&&(this.rangeSelect.value=e.value);return}}},renderButtons(t,e){if(!this.container)return;if(this.container.innerHTML="",t.length===0){this.container.innerHTML='<p class="text-gray-400 p-4 text-sm w-full text-center">ไม่พบตอนในช่วงนี้</p>';return}const n=document.createDocumentFragment();t.forEach(r=>{const i=document.createElement("button"),s=r.id===this.activeEpisodeId;i.className=`ep-button w-12 h-12 flex-shrink-0 bg-gray-700 hover:bg-gray-600 rounded-md flex items-center justify-center font-medium transition-colors duration-200 text-sm ${this._getStatusClass(r.status)} ${s?"active bg-green-600 text-white":""}`,i.textContent=r.number,i.dataset.id=r.id,i.onclick=()=>e(r),n.appendChild(i)}),this.container.appendChild(n),this.scrollToActive()},highlightActive(t){this.activeEpisodeId=t,document.querySelectorAll(".ep-button").forEach(e=>{e.dataset.id===t?(e.classList.add("active","bg-green-600","text-white"),e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})):e.classList.remove("active","bg-green-600","text-white")})},scrollToActive(){setTimeout(()=>{const t=this.container.querySelector(".ep-button.active");t&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})},100)},hasButtonFor(t){return this.container?Array.from(this.container.children).some(e=>e.textContent==t):!1},_getStatusClass(t){return t==="broken"||t==="user_reported"?"border-2 border-red-500 bg-red-900/30 text-red-300":""}};async function V(t,e,n){if(R.init(t),w.init(),!e||e===0){w.renderEmpty();return}w.setupRangeSelector(e,async(r,i)=>{await _(r,i,null,n)})}async function _(t,e,n,r){w.renderLoading();try{const i=await R.fetchByRange(t,e);return w.renderButtons(i,r),i}catch{return w.renderError(),[]}}function G(t){w.highlightActive(t)}async function gt(t,e,n){const r=e==="next"?t+1:t-1;return r<1?null:await R.findSingleEpisode(r)}async function k(t,e){const r=Math.floor((t-1)/50)*50+1,i=r+50-1;w.hasButtonFor(t)||(await _(r,i,null,e),w.updateRangeSelector(t))}const bt=Object.freeze(Object.defineProperty({__proto__:null,checkAndLoadEpisodeBatch:k,findNextPrevEpisode:gt,highlightActiveEpisode:G,initEpisodeList:V,loadEpisodesByRange:_},Symbol.toStringTag,{value:"Module"})),A={async checkStatus(t,e){if(!t||!e)return!1;try{const n=S(l,`artifacts/${u}/users/${t}/bookmarks`,e);return(await H(n)).exists()}catch(n){return console.error("Bookmark Check Error:",n),!1}},async toggle(t,e,n){if(!t||!e)throw new Error("Missing User or Show Data");const r=S(l,`artifacts/${u}/users/${t}/bookmarks`,e.id);if(n)return await K(r),!1;{const i={title:e.title,thumbnailUrl:e.thumbnailUrl||"",tags:e.tags||[],isCompleted:e.isCompleted||!1,latestEpisodeNumber:e.latestEpisodeNumber||0,savedAt:N()};return await q(r,i),!0}}},x={btn:null,init(){this.btn=document.getElementById("btn-bookmark")},updateState(t,e){if(this.btn){if(!e){this._renderButton('<i class="ri-heart-add-line"></i> เพิ่มรายการโปรด (Login)',"gray");return}t?this._renderButton('<i class="ri-heart-fill text-red-500"></i> รายการโปรด',"red"):this._renderButton('<i class="ri-heart-line"></i> เพิ่มรายการโปรด',"gray")}},toggleLoading(t){this.btn&&(this.btn.disabled=t,t?this.btn.classList.add("opacity-50","cursor-not-allowed"):this.btn.classList.remove("opacity-50","cursor-not-allowed"))},_renderButton(t,e){this.btn.innerHTML=t,e==="red"?this.btn.className="flex items-center gap-2 px-4 py-2 rounded-full border border-red-500 text-sm text-red-400 hover:bg-gray-800 transition-colors cursor-pointer select-none":this.btn.className="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-400 hover:bg-gray-800 transition-colors cursor-pointer select-none"}};let C=!1;async function yt(t,e){x.init(),x.btn&&(x.updateState(!1,!!t),t&&e&&(C=await A.checkStatus(t.uid,e.id),x.updateState(C,!0)),x.btn.onclick=async()=>{if(!t){confirm(`คุณต้องเข้าสู่ระบบเพื่อบันทึกรายการโปรด
ต้องการเข้าสู่ระบบหรือไม่?`)&&window.triggerLogin();return}x.toggleLoading(!0);try{C=await A.toggle(t.uid,e,C),x.updateState(C,!0)}catch(n){console.error(n),alert("เกิดข้อผิดพลาดในการบันทึก")}finally{x.toggleLoading(!1)}})}const wt={async submitReport(t,e,n){return await O(v(l,`artifacts/${u}/public/data/reports`),{episodeId:n.id,showId:e,reportedBy:"user",userId:t.uid,reason:"Broken Link",createdAt:N()}),await J(S(l,`artifacts/${u}/public/data/episodes`,n.id),{status:"user_reported"}),!0}},g={btn:null,alertDiv:null,init(){this.btn=document.getElementById("report-broken-btn"),this.alertDiv=document.getElementById("broken-alert")},updateState(t){this.btn&&(t==="broken"||t==="user_reported"?(this.btn.disabled=!0,this.btn.innerHTML=t==="broken"?'<i class="ri-check-line"></i> แจ้งแล้ว (เสีย)':'<i class="ri-check-line"></i> แจ้งแล้ว (รอตรวจสอบ)',this.btn.className="flex items-center bg-red-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors opacity-50 cursor-not-allowed",this.alertDiv&&this.alertDiv.classList.remove("hidden")):(this.btn.disabled=!1,this.btn.innerHTML='<i class="ri-error-warning-line mr-1"></i> แจ้ง (เสีย)',this.btn.className="flex items-center bg-gray-700 hover:bg-red-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors cursor-pointer",this.alertDiv&&this.alertDiv.classList.add("hidden")))},setLoading(t){this.btn&&(this.btn.disabled=t,t&&(this.btn.textContent="กำลังแจ้ง..."))},confirmAction(t){return confirm(`ยืนยันแจ้งไฟล์เสียสำหรับตอนที่ ${t}?`)}};function xt(t,e,n){g.init(),g.btn&&(g.btn.onclick=async()=>{const r=n();if(r){if(!t){alert("กรุณาเข้าสู่ระบบก่อนแจ้งปัญหา"),window.triggerLogin();return}if(g.confirmAction(r.number)){g.setLoading(!0);try{await wt.submitReport(t,e.id,r),r.status="user_reported",g.updateState("user_reported")}catch(i){console.error(i),alert("แจ้งปัญหาล้มเหลว: "+i.message),g.updateState(r.status)}}}})}function Et(t){g.init(),g.updateState(t.status)}const vt={async fetchRelated(t,e){if(!t||t.length===0)return[];const n=y(v(l,`artifacts/${u}/public/data/shows`),b("tags","array-contains-any",t.slice(0,5)),L(12)),r=await I(n),i=[];return r.forEach(s=>{s.id!==e&&i.push({id:s.id,...s.data()})}),i}},St={render(t,e){const n=document.getElementById("related-list-container");if(!n)return;if(n.className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",t.length===0){n.innerHTML='<p class="text-gray-500 col-span-full text-center py-4">ไม่มีอนิเมะที่เกี่ยวข้อง</p>';return}let r="";t.forEach(i=>{const s=e.find(a=>a.showId===i.id);r+=st(i,null,s)}),n.innerHTML=r,j(n)}};async function Lt(t,e){try{const n=await vt.fetchRelated(t.tags,t.id);St.render(n,e)}catch(n){console.warn("Related fetch error",n)}}const It={async fetchTop10(){const t=y(v(l,`artifacts/${u}/public/data/shows`),T("viewCount","desc"),L(10));return(await I(t)).docs.map(n=>({id:n.id,...n.data()}))}},Ct={render(t,e){const n=document.getElementById("top10-list-container");if(!n)return;let r="";t.forEach((i,s)=>{const a=s+1,o=e.find(f=>f.showId===i.id);let c=`player.html?id=${i.id}`;o&&o.lastWatchedEpisodeId&&(c+=`&ep_id=${o.lastWatchedEpisodeId}`),r+=`
                <a href="${c}" class="top10-item hover:shadow-lg bg-gray-700 flex items-center p-2 rounded-lg mb-2 transition-colors group"> 
                    <span class="rank-badge-lg rank-${a} w-8 text-center font-bold text-xl mr-3 ${this._getRankColor(a)}">${a}</span>
                    <img src="${i.thumbnailUrl}" class="w-12 h-16 object-cover rounded shadow-md bg-gray-600 flex-shrink-0">
                    <div class="top10-content flex-grow ml-3 min-w-0">
                        <h4 class="font-bold text-white line-clamp-2 text-sm group-hover:text-green-400 transition-colors">${i.title}</h4>
                        <p class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                            <i class="ri-eye-line"></i> ${i.viewCount||0}
                        </p>
                    </div>
                </a>`}),n.innerHTML=r},_getRankColor(t){return t===1?"text-yellow-400":t===2?"text-gray-300":t===3?"text-orange-400":"text-gray-500"}};async function Tt(t){try{const e=await It.fetchTop10();Ct.render(e,t)}catch(e){console.error("Top 10 Error",e)}}const B={showId:null,episodeId:null,episodeNum:null,lastCursor:null,activeTab:"episode",init(t,e,n){this.showId=t,this.episodeId=e,this.episodeNum=n,this.lastCursor=null,this.activeTab="episode"},setTab(t){return this.activeTab!==t?(this.activeTab=t,this.lastCursor=null,!0):!1},async fetchComments(t=!1){const e=v(l,`artifacts/${u}/public/data/comments`);let n;if(this.activeTab==="episode"){if(!this.episodeId)throw new Error("Missing Episode ID");n=y(e,b("episodeId","==",this.episodeId),T("createdAt","desc"))}else n=y(e,b("showId","==",this.showId),b("type","==","show"),T("createdAt","desc"));let r=y(n,L(20));!t&&this.lastCursor&&(r=y(n,X(this.lastCursor),L(20)));const i=await I(r);return i.empty?t&&(this.lastCursor=null):this.lastCursor=i.docs[i.docs.length-1],{items:i.docs.map(s=>s.data()),hasMore:i.docs.length>=20,isEmpty:t&&i.empty}},async post(t,e){if(!t||!this.showId)throw new Error("Unauthorized or Missing ID");const n={userId:t.uid,userName:t.displayName||"User",userPhoto:t.photoURL||"",text:e,createdAt:N(),showId:this.showId,episodeId:this.episodeId||null,episodeNum:this.episodeNum||0,type:this.activeTab};await O(v(l,`artifacts/${u}/public/data/comments`),n),this.lastCursor=null}},m={listContainer:null,btnMore:null,tabEpisode:null,tabShow:null,isLoading:!1,init(){this.listContainer=document.getElementById("comments-list"),this.btnMore=document.getElementById("btn-load-more-comments"),this.tabEpisode=document.getElementById("tab-comment-episode"),this.tabShow=document.getElementById("tab-comment-show")},setupTabs(t,e){if(!this.tabEpisode||!this.tabShow)return;const n=t?`ตอนที่ ${t}`:"ตอนนี้";this.tabEpisode.innerHTML=`<i class="ri-movie-2-line mr-1"></i> พูดคุย${n}`,this.tabShow.innerHTML='<i class="ri-discuss-line mr-1"></i> พูดคุยทั้งเรื่อง',this.tabEpisode.onclick=()=>e("episode"),this.tabShow.onclick=()=>e("show")},updateTabState(t){if(!this.tabEpisode||!this.tabShow)return;const e="flex-1 py-3 text-sm font-bold text-green-400 border-b-2 border-green-500 bg-gray-800/80 transition-all cursor-default",n="flex-1 py-3 text-sm font-medium text-gray-400 border-b border-gray-700 hover:text-white hover:bg-gray-800 transition-all cursor-pointer";t==="episode"?(this.tabEpisode.className=e,this.tabShow.className=n):(this.tabShow.className=e,this.tabEpisode.className=n)},renderLoading(t){this.listContainer&&(this.isLoading=!0,t?(this.listContainer.innerHTML=`
                <div class="flex flex-col items-center justify-center py-8 text-gray-500 animate-pulse">
                    <i class="ri-loader-4-line text-2xl animate-spin mb-2"></i>
                    <span class="text-xs">กำลังโหลดความคิดเห็น...</span>
                </div>`,this.btnMore&&this.btnMore.classList.add("hidden")):this.btnMore&&(this.btnMore.innerHTML='<i class="ri-loader-4-line animate-spin"></i> กำลังโหลด...',this.btnMore.disabled=!0))},renderList(t,e,n){if(this.isLoading=!1,!!this.listContainer){if(e&&(this.listContainer.innerHTML=""),t.isEmpty){const r=n==="episode"?"ยังไม่มีใครคุยเกี่ยวกับตอนนี้เลย":"ยังไม่มีการพูดคุยในภาพรวม";this.listContainer.innerHTML=`
                <div class="text-center py-8">
                    <div class="bg-gray-800/50 inline-flex p-3 rounded-full mb-3 text-gray-500">
                        <i class="ri-chat-1-line text-2xl"></i>
                    </div>
                    <p class="text-gray-400 text-sm">${r}</p>
                    <p class="text-gray-600 text-xs mt-1">มาเริ่มเปิดประเด็นกันเถอะ!</p>
                </div>`}else{const r=document.createDocumentFragment();t.items.forEach(i=>r.appendChild(this._createCommentElement(i,n))),this.listContainer.appendChild(r)}this.btnMore&&(t.hasMore?(this.btnMore.classList.remove("hidden"),this.btnMore.innerHTML="โหลดความคิดเห็นเพิ่มเติม...",this.btnMore.disabled=!1):this.btnMore.classList.add("hidden"))}},renderError(t,e){if(this.isLoading=!1,!this.listContainer)return;let n=`<p class="text-red-500 text-sm text-center py-4">เกิดข้อผิดพลาด: ${t.message}</p>`;if(t.message.includes("index")){const r=t.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);r&&(n=`
                    <div class="text-center p-4 border border-yellow-600 bg-yellow-900/30 rounded-lg my-4">
                        <i class="ri-alert-line text-2xl text-yellow-500 mb-2 block"></i>
                        <p class="text-yellow-500 text-sm mb-2 font-bold">⚠️ จำเป็นต้องสร้าง Index ใหม่</p>
                        <a href="${r[0]}" target="_blank" class="inline-block bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-full text-xs font-bold transition-colors">คลิกสร้าง Index</a>
                    </div>`)}e?this.listContainer.innerHTML=n:this.listContainer.insertAdjacentHTML("beforeend",n),this.btnMore&&this.btnMore.classList.add("hidden")},togglePostLoading(t){const e=document.getElementById("btn-post-comment");e&&(t?(e.dataset.originalText=e.innerHTML,e.disabled=!0,e.innerHTML='<i class="ri-loader-4-line animate-spin"></i>'):(e.disabled=!1,e.innerHTML=e.dataset.originalText||"โพสต์"))},clearInput(){const t=document.getElementById("comment-input");t&&(t.value="")},_createCommentElement(t,e){const n=document.createElement("div");n.className="group flex gap-3 mb-4 border-b border-gray-800 pb-4 last:border-0 hover:bg-gray-800/30 p-2 rounded-lg transition-colors";const r=document.createElement("img");r.src=t.userPhoto||"https://placehold.co/40x40?text=?",r.className="w-10 h-10 rounded-full bg-gray-700 object-cover flex-shrink-0 shadow-sm";const i=document.createElement("div");i.className="flex-1 min-w-0";const s=document.createElement("div");s.className="flex items-center flex-wrap gap-y-1 mb-1";const a=document.createElement("span");a.className="font-bold text-sm text-green-400 mr-2",a.textContent=t.userName||"Guest";const o=document.createElement("span");if(o.className="text-xs text-gray-500",o.textContent=t.createdAt?rt(t.createdAt):"เมื่อสักครู่",s.appendChild(a),s.appendChild(o),e==="show"&&t.episodeNum){const f=document.createElement("span");f.className="bg-gray-700 text-gray-300 text-[10px] px-1.5 py-0.5 rounded ml-2",f.textContent=`Ep.${t.episodeNum}`,s.appendChild(f)}const c=document.createElement("p");return c.className="text-sm text-gray-200 whitespace-pre-line leading-relaxed",c.textContent=t.text,i.appendChild(s),i.appendChild(c),n.appendChild(r),n.appendChild(i),n}};function Bt(t,e,n){B.init(t,e,n),m.init(),m.setupTabs(n,i=>{B.setTab(i)&&(m.updateTabState(i),M(!0))}),m.updateTabState("episode"),M(!0);const r=document.getElementById("btn-load-more-comments");if(r){const i=r.cloneNode(!0);r.parentNode.replaceChild(i,r),m.btnMore=i,i.onclick=()=>M(!1)}}async function M(t=!1){if(!m.isLoading){m.renderLoading(t);try{const e=await B.fetchComments(t);m.renderList(e,t,B.activeTab)}catch(e){console.error("Load Comments Error",e),m.renderError(e,t)}}}async function Mt(t){const e=document.getElementById("comment-input"),n=e?e.value.trim():"";if(!(!t||!n)){m.togglePostLoading(!0);try{await B.post(t,n),m.clearInput(),await M(!0)}catch(r){console.error("Post Error",r),alert("ส่งความคิดเห็นไม่สำเร็จ: "+r.message)}finally{m.togglePostLoading(!1)}}}function kt(t){const e=document.getElementById("comment-login-prompt"),n=document.getElementById("comment-input-area"),r=document.getElementById("comment-user-avatar");!e||!n||(t?(e.classList.add("hidden"),n.classList.remove("hidden"),r&&(r.src=t.photoURL||"https://placehold.co/40x40")):(e.classList.remove("hidden"),n.classList.add("hidden")))}let $=null,P=!0,D=!1;async function E(t){if(!t){h.renderErrorState("ไม่พบข้อมูลตอน");return}const e=W(t,$);e&&(h.renderPlayer(e.embedHtml),h.updateMetaData(e.metaData),h.updateNavButtons(e.navStatus),G(e.episodeId),Et(t),Bt(e.showId,e.episodeId,e.episodeNumber),P||window.scrollTo({top:0,behavior:"smooth"}),P=!1)}async function U(t){h.updateNavButtons({canGoPrev:!1,canGoNext:!1});try{const e=await ut(t,bt);if(e)await k(e.number,E),E(e);else{const n=F();if(n.currentEpisode){const r=W(n.currentEpisode,$);h.updateNavButtons(r.navStatus)}}}catch(e){console.error("Nav Error:",e)}}document.addEventListener("DOMContentLoaded",async()=>{var t,e,n;Y("silent"),await et(".."),(t=document.getElementById("prev-episode-btn"))==null||t.addEventListener("click",()=>U("prev")),(e=document.getElementById("next-episode-btn"))==null||e.addEventListener("click",()=>U("next")),(n=document.getElementById("btn-post-comment"))==null||n.addEventListener("click",()=>Mt($)),h.toggleLoading(!0),Z(tt,async r=>{$=r,kt(r);const i=new URLSearchParams(window.location.search),s=i.get("id"),a=i.get("ep_id");if(!s){h.toggleLoading(!0,"URL ไม่ถูกต้อง (Missing Show ID)");return}try{const o=await lt(s);h.renderShowInfo(o);let c=[];r&&(c=await ot(r.uid)),D||(it(c||[]),D=!0),yt(r,o),xt(r,o,()=>F().currentEpisode),Lt(o,c),Tt(c),setTimeout(()=>j(document.getElementById("top10-list-container")),1e3);let f=a;if(!f&&c.length>0){const p=c.find(z=>z.showId===s);p&&(f=p.lastWatchedEpisodeId)}if(await V(s,o.latestEpisodeNumber,E),f){const p=await dt(f);p?(await k(p.number,E),E(p)):(await k(1,E),h.renderErrorState("ไม่พบตอนที่ระบุ กรุณาเลือกจากรายการ"))}else{const p=await _(1,50,document.getElementById("episode-list-container"),E);(p==null?void 0:p.length)>0?E(p[0]):h.renderErrorState("ยังไม่มีตอนในขณะนี้")}h.toggleLoading(!1),h.checkDescriptionOverflow()}catch(o){h.toggleLoading(!0,`Error: ${o.message}`)}}),window.addEventListener("popstate",()=>window.location.reload())});
