import{G as _,p as q,o as F,b as w,r as G,t as O,u as z,v as J,x as j,i as Q,d as L,a as v,m as V,y as U,z as K}from"./db-config-JzEx42YR.js";import{query as k,collection as T,limit as A,getDocs as $,getDoc as X,doc as Y}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const Z=new _;function C(t){switch(t){case"auth/email-already-in-use":return"อีเมลนี้มีผู้ใช้งานแล้ว";case"auth/wrong-password":return"รหัสผ่านไม่ถูกต้อง";case"auth/user-not-found":return"ไม่พบผู้ใช้งานอีเมลนี้";case"auth/weak-password":return"รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร";case"auth/invalid-email":return"รูปแบบอีเมลไม่ถูกต้อง";case"auth/popup-closed-by-user":return"คุณปิดหน้าต่างล็อกอินก่อนทำรายการสำเร็จ";case"auth/too-many-requests":return"ทำรายการถี่เกินไป โปรดรอสักครู่";default:return"เกิดข้อผิดพลาด: "+t}}async function P(t){var n;if(t)try{const e=Q(L,`artifacts/${v}/users/${t.uid}`),o=await V(e),a={uid:t.uid,email:t.email,displayName:t.displayName||"User",photoURL:t.photoURL||`https://ui-avatars.com/api/?name=${t.email.charAt(0)}&background=random`,lastLoginAt:U(),authProvider:((n=t.providerData[0])==null?void 0:n.providerId)||"password"};o.exists()||(a.createdAt=U(),a.role="user"),await K(e,a,{merge:!0})}catch(e){console.error("Error saving user:",e)}}async function tt(){const t=await G(w,Z);return await P(t.user),t.user}async function et(t,n,e){const o=await O(w,t,n);return await z(o.user,{displayName:e,photoURL:`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&background=random`}),await P(o.user),o.user}async function nt(t,n){const e=await J(w,t,n);return await P(e.user),e.user}async function ot(t){await j(w,t)}async function st(){await q(w),window.location.reload()}function at(t){F(w,n=>{t&&t(n)})}function it(){const t=document.getElementById("btn-random-anime"),n=document.getElementById("btn-random-anime-mobile"),e=async()=>{try{const o=k(T(L,`artifacts/${v}/public/data/shows`),A(20)),a=await $(o);if(a.empty)window.showToast&&window.showToast("ไม่พบข้อมูลอนิเมะ","error");else{const c=Math.floor(Math.random()*a.docs.length),i=a.docs[c].id,m=window.location.pathname.includes("/pages/")?"":"pages/";window.location.href=`${m}player.html?id=${i}`}}catch(o){console.error(o),window.showToast&&window.showToast("เกิดข้อผิดพลาดในการสุ่ม","error")}};t&&(t.onclick=e),n&&(n.onclick=e)}async function ct(t){const n=document.getElementById("btn-notification"),e=document.getElementById("notif-badge"),o=document.getElementById("notification-list"),a=document.getElementById("notification-dropdown");if(!(!n||!e||!o||!a))try{const c=T(L,`artifacts/${v}/users/${t}/bookmarks`),i=await $(k(c,A(20)));if(i.empty){e.classList.add("hidden");return}const d=T(L,`artifacts/${v}/users/${t}/viewHistory`),m=await $(k(d)),s=new Map;m.forEach(u=>s.set(u.data().showId,u.data().lastWatchedEpisodeNumber||0));let g=[];for(const u of i.docs){const f=u.id,h=await X(Y(L,`artifacts/${v}/public/data/shows`,f));if(!h.exists())continue;const r=h.data(),p=r.latestEpisodeNumber||0,B=s.get(f)||0;p>B&&g.push({title:r.title,ep:p,id:f,thumbnail:r.thumbnailUrl})}if(g.length>0){e.textContent=g.length,e.classList.remove("hidden");const f=window.location.pathname.includes("/pages/")?"":"pages/";let h="";g.forEach(r=>{h+=`
                    <a href="${f}player.html?id=${r.id}&ep_id=latest" class="block p-3 hover:bg-gray-700 border-b border-gray-700 last:border-0 flex gap-3 items-center transition-colors">
                        <img src="${r.thumbnail}" class="w-10 h-14 object-cover rounded bg-gray-700" onerror="this.src='https://placehold.co/40x60'">
                        <div class="min-w-0">
                            <p class="text-xs text-green-400 font-bold">ตอนใหม่! ตอนที่ ${r.ep}</p>
                            <p class="text-sm text-white truncate">${r.title}</p>
                        </div>
                    </a>
                `}),o.innerHTML=h}else e.classList.add("hidden"),o.innerHTML='<p class="text-center text-gray-500 text-xs p-4">ไม่มีการแจ้งเตือนใหม่</p>';n.onclick=u=>{u.stopPropagation(),a.classList.toggle("hidden")},document.addEventListener("click",u=>{!a.contains(u.target)&&!n.contains(u.target)&&a.classList.add("hidden")})}catch(c){console.error("Notification Error:",c)}}window.showToast=(t,n="success")=>{const e=document.getElementById("toast-container");if(!e)return;const o=document.createElement("div");o.className=`pointer-events-auto flex items-center gap-3 w-full p-4 rounded-lg shadow-xl border-l-4 toast-enter transition-all ${n==="success"?"bg-gray-800 border-green-500 text-white":n==="error"?"bg-gray-800 border-red-500 text-white":"bg-gray-800 border-blue-500 text-white"}`;const a=n==="success"?"ri-checkbox-circle-fill text-green-500 text-xl":n==="error"?"ri-error-warning-fill text-red-500 text-xl":"ri-information-fill text-blue-500 text-xl";o.innerHTML=`<i class="${a}"></i><div class="text-sm font-medium">${t}</div>`,e.appendChild(o),setTimeout(()=>{o.classList.remove("toast-enter"),o.classList.add("toast-exit"),setTimeout(()=>o.remove(),300)},4e3)};window.triggerLogin=()=>{const t=document.getElementById("auth-modal"),n=document.getElementById("auth-modal-content");t&&n&&(t.classList.remove("hidden"),requestAnimationFrame(()=>{t.classList.remove("opacity-0","pointer-events-none"),n.classList.remove("scale-95"),n.classList.add("scale-100")}))};function R(t){var c,i;const{name:n,photo:e}=t;(c=document.getElementById("btn-login-google"))==null||c.classList.add("hidden");const o=document.getElementById("user-profile");o&&(o.classList.remove("hidden"),document.getElementById("user-avatar").src=e,document.getElementById("user-name").textContent=n,document.getElementById("user-name-dropdown")&&(document.getElementById("user-name-dropdown").textContent=n)),(i=document.getElementById("btn-login-google-mobile"))==null||i.classList.add("hidden");const a=document.getElementById("mobile-user-profile");a&&(a.classList.remove("hidden"),document.getElementById("mobile-user-avatar").src=e,document.getElementById("mobile-user-name").textContent=n)}function S(){var t,n,e,o;(t=document.getElementById("btn-login-google"))==null||t.classList.remove("hidden"),(n=document.getElementById("user-profile"))==null||n.classList.add("hidden"),(e=document.getElementById("btn-login-google-mobile"))==null||e.classList.remove("hidden"),(o=document.getElementById("mobile-user-profile"))==null||o.classList.add("hidden")}async function ht(t="."){const n=document.getElementById("navbar-placeholder");if(n){n.hasChildNodes()||(n.innerHTML='<header class="bg-gray-900/95 h-16 sticky top-0 z-50"></header>');try{const e=await fetch(`${t}/components/navbar.html`);if(!e.ok)throw new Error("Failed to load navbar");let o=await e.text();o=o.replace(/href="([^"]*)"/g,(c,i)=>{if(i.startsWith("#")||i.startsWith("http"))return c;const d=i.startsWith("/")?i.substring(1):i;return`href="${t}/${d}"`}),o=o.replace(/src="([^"]*)"/g,(c,i)=>{if(i.startsWith("http"))return c;const d=i.startsWith("/")?i.substring(1):i;return`src="${t}/${d}"`}),n.innerHTML=o;const a=localStorage.getItem("ani_user_cache");if(a)try{R(JSON.parse(a))}catch{localStorage.removeItem("ani_user_cache"),S()}else S();lt(),dt(),rt(),mt()}catch(e){console.error("Navbar load error:",e)}}}function rt(){const t=document.getElementById("auth-modal"),n=document.getElementById("auth-modal-content"),e=document.getElementById("btn-close-auth"),o=document.getElementById("btn-auth-google"),a=document.getElementById("email-auth-form"),c=document.getElementById("auth-modal-title"),i=document.getElementById("auth-icon"),d=document.getElementById("field-name-container"),m=document.getElementById("field-password-container"),s=document.getElementById("social-auth-section"),g=document.getElementById("auth-footer"),u=document.getElementById("auth-name"),f=document.getElementById("auth-email"),h=document.getElementById("auth-password"),r=document.getElementById("btn-submit-auth"),p=document.getElementById("btn-switch-mode"),B=document.getElementById("auth-switch-text"),M=document.getElementById("btn-forgot-password"),y=document.getElementById("btn-back-login");let l="login";const b=()=>{u.required=l==="register",h.required=l!=="forgot",l==="login"?(c.textContent="เข้าสู่ระบบ",i.className="ri-login-circle-line text-green-500",d.classList.add("hidden"),m.classList.remove("hidden"),s.classList.remove("hidden"),g.classList.remove("hidden"),y.classList.add("hidden"),r.innerHTML="เข้าสู่ระบบ",B.textContent="ยังไม่มีบัญชี?",p.textContent="สมัครสมาชิกฟรี"):l==="register"?(c.textContent="สมัครสมาชิกใหม่",i.className="ri-user-add-line text-green-500",d.classList.remove("hidden"),m.classList.remove("hidden"),s.classList.remove("hidden"),g.classList.remove("hidden"),y.classList.add("hidden"),r.innerHTML="สมัครสมาชิก",B.textContent="มีบัญชีอยู่แล้ว?",p.textContent="เข้าสู่ระบบ"):l==="forgot"&&(c.textContent="รีเซ็ตรหัสผ่าน",i.className="ri-lock-unlock-line text-yellow-500",d.classList.add("hidden"),m.classList.add("hidden"),s.classList.add("hidden"),g.classList.add("hidden"),y.classList.remove("hidden"),r.innerHTML="ส่งลิงก์รีเซ็ต")};p&&(p.onclick=()=>{l=l==="login"?"register":"login",b()}),M&&(M.onclick=()=>{l="forgot",b()}),y&&(y.onclick=()=>{l="login",b()});const E=()=>{t&&n&&(t.classList.add("opacity-0","pointer-events-none"),n.classList.remove("scale-100"),n.classList.add("scale-95"),setTimeout(()=>{t.classList.add("hidden"),l="login",b(),a.reset()},300))};e&&(e.onclick=E),t&&(t.onclick=I=>{I.target===t&&E()}),o&&(o.onclick=async()=>{try{await tt(),E(),window.showToast("เข้าสู่ระบบสำเร็จ! ยินดีต้อนรับ","success")}catch(I){window.showToast(C(I.code),"error")}}),a&&(a.onsubmit=async I=>{I.preventDefault();const x=f.value,N=h.value,H=u.value,D=r.innerHTML;r.innerHTML='<i class="ri-loader-4-line animate-spin mr-2"></i> กำลังดำเนินการ...',r.disabled=!0;try{l==="register"?(await et(x,N,H),window.showToast("สมัครสมาชิกสำเร็จ!","success"),E()):l==="login"?(await nt(x,N),window.showToast("เข้าสู่ระบบสำเร็จ","success"),E()):l==="forgot"&&(await ot(x),window.showToast("ส่งลิงก์รีเซ็ตแล้ว","info"),setTimeout(()=>{l="login",b()},2e3))}catch(W){window.showToast(C(W.code),"error")}finally{r.innerHTML=D,r.disabled=!1}})}function dt(){const t=[document.getElementById("btn-login-google"),document.getElementById("btn-login-google-mobile")],n=[document.getElementById("btn-logout"),document.getElementById("btn-logout-mobile")];t.forEach(e=>{e&&(e.onclick=window.triggerLogin)}),n.forEach(e=>{e&&(e.onclick=async()=>{confirm("ต้องการออกจากระบบ?")&&(localStorage.removeItem("ani_user_cache"),await st())})}),at(e=>{if(e){const o=e.displayName||e.email.split("@")[0],a=e.photoURL||`https://ui-avatars.com/api/?name=${o}&background=random`,c={name:o,photo:a};localStorage.setItem("ani_user_cache",JSON.stringify(c)),R(c),ct(e.uid)}else localStorage.removeItem("ani_user_cache"),S()})}function lt(){const t=document.getElementById("mobile-menu-btn"),n=document.getElementById("mobile-menu"),e=document.getElementById("mobile-search-button"),o=document.getElementById("mobile-search-bar"),a=document.getElementById("mobile-close-search"),c=s=>s==null?void 0:s.classList.toggle("hidden"),i=s=>s==null?void 0:s.classList.add("hidden"),d=s=>s==null?void 0:s.classList.remove("hidden"),m=s=>!(s!=null&&s.classList.contains("hidden"));t&&n&&(t.onclick=s=>{s.stopPropagation(),c(n),m(n)&&i(o)}),e&&o&&(e.onclick=s=>{s.preventDefault(),s.stopPropagation(),d(o),i(n),setTimeout(()=>{var g;return(g=document.getElementById("mobile-search-input"))==null?void 0:g.focus()},100)}),a&&(a.onclick=s=>{s.stopPropagation(),i(o)}),document.addEventListener("click",s=>{n&&m(n)&&!n.contains(s.target)&&!t.contains(s.target)&&i(n),o&&m(o)&&!o.contains(s.target)&&!e.contains(s.target)&&i(o)}),it()}function mt(){const t=window.location.pathname.split("/").pop()||"index.html",n=new URLSearchParams(window.location.search);document.querySelectorAll(".nav-link").forEach(e=>{const o=e.getAttribute("href");if(!o)return;const a=o.replace(/^(\.\.\/|\.\/)/,"").split("?")[0];if(a!==t&&!(a==="index.html"&&t==="")){e.classList.remove("bg-gray-800","text-white","border-green-500","shadow-inner"),e.classList.add("text-gray-300");return}let c=!0;if(o.includes("?")){const i=o.split("?")[1],d=new URLSearchParams(i);for(const[m,s]of d.entries())if(n.get(m)!==decodeURIComponent(s)){c=!1;break}}c&&(e.classList.remove("text-gray-300","hover:text-white"),e.classList.add("bg-gray-800","text-white","border-green-500","shadow-inner"))})}export{ht as l};
