import{d,a as m,s as oe,o as se,m as F,i as G,b as ie}from"./db-config-JzEx42YR.js";import{l as ae}from"./navbar-DtgS--Xs.js";import{s as K}from"./search-CnOzQKex.js";import{a as le,f as ce}from"./tools-Cv2G4J4g.js";import{query as b,collection as w,where as h,orderBy as H,getDocs as B,limit as $,doc as C,getDoc as de,deleteDoc as me,serverTimestamp as q,setDoc as X,runTransaction as ue,addDoc as Y,updateDoc as pe,startAfter as fe}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import{c as ge}from"./card-DUAddn7M.js";function ye(e){document.getElementById("show-title").textContent=e.title;const t=document.getElementById("show-description"),n=document.getElementById("expand-desc-btn");t.textContent=e.description||"ไม่มีคำอธิบาย",t.scrollHeight>t.clientHeight&&(n.classList.remove("hidden"),n.onclick=()=>{t.classList.toggle("line-clamp-2"),n.textContent=t.classList.contains("line-clamp-2")?"เพิ่มเติม":"ย่อ"})}function Z(e){const t=document.getElementById("video-player-embed");if(t.innerHTML="",!e){t.innerHTML='<p class="text-gray-400 p-4">ยังไม่มีตอนสำหรับอนิเมะนี้</p>';return}const n=e.videoUrl||e.embedCode;if(!n){t.innerHTML='<p class="text-red-500 p-4">ไม่พบลิงก์วิดีโอ</p>';return}t.innerHTML=le(n)}function T(e,t){let n=document.querySelector(`meta[property="${e}"]`);n||(n=document.createElement("meta"),n.setAttribute("property",e),document.head.appendChild(n)),n.setAttribute("content",t)}function be(e,t){if(!e)return;const n=t?` ตอนที่ ${t.number}`:"",r=`${e.title}${n} | ANI-END`,o=e.description||`ดูอนิเมะ ${e.title} ฟรีที่ ANI-END`,s=e.thumbnailUrl||"https://placehold.co/600x400?text=ANI-END";document.title=r,T("og:title",r),T("og:description",o),T("og:image",s),T("og:url",window.location.href),T("og:type","video.episode");let i=document.querySelector('meta[name="twitter:card"]');if(i||(i=document.createElement("meta"),i.setAttribute("name","twitter:card"),document.head.appendChild(i)),i.setAttribute("content","summary_large_image"),t){const a=document.getElementById("show-title");a.textContent=`${e.title} - ${t.title||"ตอนที่ "+t.number}`;try{const l=new URL(window.location.href);l.searchParams.set("ep_id",t.id),window.history.pushState({},"",l.href)}catch{}}}const L=50;let O=null,S=[],j=null;async function V(e,t,n){O=e;const r=document.getElementById("episode-list-container"),o=document.getElementById("episode-range-container"),s=document.getElementById("episode-range-select");if(he(t,s,o,async(i,a)=>{await z(i,a,r,n)}),!t||t===0){r.innerHTML='<p class="text-gray-500 text-sm">ยังไม่มีตอน</p>';return}}function he(e,t,n,r){const o=e||0;if(o===0){n.classList.add("hidden");return}const s=Math.ceil(o/L);let i="";for(let a=0;a<s;a++){const l=a*L+1,c=Math.min((a+1)*L,o);i+=`<option value="${l}-${c}">ตอนที่ ${l} - ${c}</option>`}s===0&&(i='<option value="">ไม่มีตอน</option>'),t.innerHTML=i,n.classList.remove("hidden"),t.onchange=a=>{if(!a.target.value)return;const[l,c]=a.target.value.split("-").map(Number);r(l,c)}}async function z(e,t,n,r){n.innerHTML='<p class="text-gray-400 p-2 text-sm">กำลังโหลด...</p>';try{const o=b(w(d,`artifacts/${m}/public/data/episodes`),h("showId","==",O),h("number",">=",e),h("number","<=",t),H("number","asc"));return S=(await B(o)).docs.map(i=>({id:i.id,...i.data()})),xe(S,n,r),S}catch(o){return console.error("Load episodes error:",o),n.innerHTML='<p class="text-red-500 text-sm">โหลดข้อมูลล้มเหลว</p>',[]}}function xe(e,t,n){if(t.innerHTML="",e.length===0){t.innerHTML='<p class="text-gray-400 p-4 text-sm w-full text-center">ไม่พบตอนในช่วงนี้</p>';return}e.forEach(r=>{const o=document.createElement("button");let s="";r.id===j&&(s="active bg-green-600 text-white"),o.className=`ep-button w-12 h-12 flex-shrink-0 bg-gray-700 hover:bg-gray-600 rounded-md flex items-center justify-center font-medium transition-colors duration-200 text-sm ${we(r.status)} ${s}`,o.textContent=r.number,o.dataset.id=r.id,o.onclick=()=>n(r),t.appendChild(o),r.id===j&&setTimeout(()=>o.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}),100)})}function we(e){return e==="broken"||e==="user_reported"?"border-2 border-red-500 bg-red-900/30 text-red-300":""}function ve(e){j=e,document.querySelectorAll(".ep-button").forEach(t=>{t.dataset.id===e?(t.classList.add("active","bg-green-600","text-white"),t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})):t.classList.remove("active","bg-green-600","text-white")})}async function Ee(e,t,n){const r=t==="next"?e+1:e-1;if(r<1)return null;const o=S.find(a=>a.number===r);if(o)return o;const s=b(w(d,`artifacts/${m}/public/data/episodes`),h("showId","==",O),h("number","==",r),$(1)),i=await B(s);return i.empty?null:{id:i.docs[0].id,...i.docs[0].data()}}function Ie(e){const t=document.getElementById("episode-range-select");if(t)for(let n of t.options){const[r,o]=n.value.split("-").map(Number);if(e>=r&&e<=o){t.value!==n.value&&(t.value=n.value);return}}}async function D(e,t){const n=document.getElementById("episode-list-container");if(!n)return;const r=Math.floor((e-1)/L)*L+1,o=r+L-1;Array.from(n.children).find(i=>i.textContent==e)||(await z(r,o,n,t),Ie(e))}let I=!1,f=null;async function Le(e,t){if(f=document.getElementById("btn-bookmark"),!!f&&(Q(!1,e),f.onclick=async()=>{if(!e){confirm(`คุณต้องเข้าสู่ระบบเพื่อบันทึกรายการโปรด
ต้องการเข้าสู่ระบบหรือไม่?`)&&window.triggerLogin();return}await $e(e,t)},e&&t))try{const n=C(d,`artifacts/${m}/users/${e.uid}/bookmarks`,t.id);I=(await de(n)).exists(),Q(I,e)}catch(n){console.error(n)}}function Q(e,t){if(!t){f.innerHTML='<i class="ri-heart-add-line"></i> เพิ่มรายการโปรด (Login)',f.className="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-400 hover:bg-gray-800 transition-colors cursor-pointer";return}e?(f.innerHTML='<i class="ri-heart-fill text-red-500"></i> รายการโปรด',f.className="flex items-center gap-2 px-4 py-2 rounded-full border border-red-500 text-sm text-red-400 hover:bg-gray-800 transition-colors cursor-pointer"):(f.innerHTML='<i class="ri-heart-line"></i> เพิ่มรายการโปรด',f.className="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-600 text-sm hover:bg-gray-800 transition-colors cursor-pointer")}async function $e(e,t){f.disabled=!0;try{const n=C(d,`artifacts/${m}/users/${e.uid}/bookmarks`,t.id);if(I)await me(n),I=!1;else{const r={title:t.title,thumbnailUrl:t.thumbnailUrl||"",tags:t.tags||[],isCompleted:t.isCompleted||!1,latestEpisodeNumber:t.latestEpisodeNumber||0,savedAt:q()};await X(n,r),I=!0}Q(I,e)}catch(n){console.error(n),alert("เกิดข้อผิดพลาดในการบันทึก")}finally{f.disabled=!1}}async function Be(e){if(!e)return[];try{const t=b(w(d,`artifacts/${m}/users/${e}/viewHistory`),H("watchedAt","desc"),$(50));return(await B(t)).docs.map(r=>({id:r.id,...r.data()}))}catch(t){return console.error("History load error:",t),[]}}async function Te(e){const n=`last_view_${e}`,r=localStorage.getItem(n),o=Date.now();if(!(r&&o-parseInt(r)<18e5))try{const s=C(d,`artifacts/${m}/public/data/shows`,e);await ue(d,async i=>{const a=await i.get(s);if(!a.exists())return;const l=(a.data().viewCount||0)+1;i.update(s,{viewCount:l})}),localStorage.setItem(n,o.toString())}catch(s){console.warn("View count skipped:",s)}}async function ke(e,t,n){if(!(!e||!t||!n))try{const r=C(d,`artifacts/${m}/users/${e}/viewHistory`,t.id),o={showId:t.id,showTitle:t.title,showThumbnail:t.thumbnailUrl||"",lastWatchedEpisodeId:n.id,lastWatchedEpisodeTitle:n.title,lastWatchedEpisodeNumber:n.number,isCompleted:t.isCompleted===!0,latestEpisodeNumber:t.latestEpisodeNumber||0,watchedAt:q()};await X(r,o,{merge:!0})}catch(r){console.error("Save history error:",r)}}function He(e,t,n){const r=document.getElementById("report-broken-btn");r&&(r.onclick=async()=>{const o=n();if(!e){alert("กรุณาเข้าสู่ระบบก่อนแจ้งปัญหา"),window.triggerLogin();return}if(o&&confirm(`ยืนยันแจ้งไฟล์เสียสำหรับตอนที่ ${o.number}?`)){r.textContent="กำลังแจ้ง...",r.disabled=!0;try{await Y(w(d,`artifacts/${m}/public/data/reports`),{episodeId:o.id,showId:t.id,reportedBy:"user",userId:e.uid,reason:"Broken Link",createdAt:q()}),await pe(C(d,`artifacts/${m}/public/data/episodes`,o.id),{status:"user_reported"}),o.status="user_reported",ee(o)}catch(s){console.error(s),r.textContent="แจ้งล้มเหลว",r.disabled=!1}}})}function ee(e){const t=document.getElementById("report-broken-btn"),n=document.getElementById("broken-alert");if(!t)return;const r=e.status;r==="broken"||r==="user_reported"?(t.disabled=!0,t.innerHTML=r==="broken"?'<i class="ri-check-line"></i> แจ้งแล้ว (เสีย)':'<i class="ri-check-line"></i> แจ้งแล้ว (รอตรวจสอบ)',t.className="flex items-center bg-red-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors opacity-50 cursor-not-allowed",n&&n.classList.remove("hidden")):(t.disabled=!1,t.innerHTML='<i class="ri-error-warning-line mr-1"></i> แจ้ง (เสีย)',t.className="flex items-center bg-gray-700 hover:bg-red-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors cursor-pointer",n&&n.classList.add("hidden"))}async function Me(e,t){const n=document.getElementById("related-list-container");if(!(!n||!e.tags||e.tags.length===0))try{const r=b(w(d,`artifacts/${m}/public/data/shows`),h("tags","array-contains-any",e.tags.slice(0,5)),$(10)),o=await B(r);let s="";o.forEach(i=>{if(i.id!==e.id){const a={id:i.id,...i.data()},l=t.find(c=>c.showId===a.id);s+=ge(a,null,l)}}),n.innerHTML=s||'<p class="text-gray-500 col-span-full text-center">ไม่มีอนิเมะที่เกี่ยวข้อง</p>'}catch(r){console.warn("Related fetch error",r)}}async function Ce(e){const t=document.getElementById("top10-list-container");if(t)try{const n=b(w(d,`artifacts/${m}/public/data/shows`),H("viewCount","desc"),$(10)),r=await B(n);let o="",s=1;r.forEach(i=>{const a={id:i.id,...i.data()},l=e.find(p=>p.showId===a.id);let c=`player.html?id=${a.id}`;l&&l.lastWatchedEpisodeId&&(c+=`&ep_id=${l.lastWatchedEpisodeId}`),o+=`
                <a href="${c}" class="top10-item hover:shadow-lg bg-gray-700 flex items-center p-2 rounded-lg mb-2 transition-colors group"> 
                    <span class="rank-badge-lg rank-${s} w-8 text-center font-bold text-xl mr-3 ${Ne(s)}">${s}</span>
                    <img src="${a.thumbnailUrl}" class="w-12 h-16 object-cover rounded shadow-md bg-gray-600 flex-shrink-0">
                    <div class="top10-content flex-grow ml-3 min-w-0">
                        <h4 class="font-bold text-white line-clamp-2 text-sm group-hover:text-green-400 transition-colors">${a.title}</h4>
                        <p class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                            <i class="ri-eye-line"></i> ${a.viewCount||0}
                        </p>
                    </div>
                </a>
            `,s++}),t.innerHTML=o}catch(n){console.error("Top 10 Error",n)}}function Ne(e){return e===1?"text-yellow-400":e===2?"text-gray-300":e===3?"text-orange-400":"text-gray-500"}let y="episode",A=null,U=null,P=null,x=null,k=!1;function W(e){return typeof e!="string"?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function Se(e,t,n){A=e,U=t,P=n,y="episode",x=null,Ae(),M(!0);const r=document.getElementById("btn-load-more-comments");if(r){const o=r.cloneNode(!0);r.parentNode.replaceChild(o,r),o.onclick=()=>M(!1)}}function Ae(){const e=document.getElementById("tab-comment-episode"),t=document.getElementById("tab-comment-show");if(!e||!t)return;const n=P?`ตอนที่ ${P}`:"ตอนนี้";e.innerHTML=`<i class="ri-movie-2-line mr-1"></i> พูดคุย${n}`,t.innerHTML='<i class="ri-discuss-line mr-1"></i> พูดคุยทั้งเรื่อง';const r=()=>{y==="episode"?(e.className="flex-1 py-3 text-sm font-bold text-green-400 border-b-2 border-green-500 bg-gray-800/80 transition-all cursor-default",t.className="flex-1 py-3 text-sm font-medium text-gray-400 border-b border-gray-700 hover:text-white hover:bg-gray-800 transition-all cursor-pointer"):(t.className="flex-1 py-3 text-sm font-bold text-green-400 border-b-2 border-green-500 bg-gray-800/80 transition-all cursor-default",e.className="flex-1 py-3 text-sm font-medium text-gray-400 border-b border-gray-700 hover:text-white hover:bg-gray-800 transition-all cursor-pointer")};e.onclick=()=>{y!=="episode"&&(y="episode",x=null,r(),M(!0))},t.onclick=()=>{y!=="show"&&(y="show",x=null,r(),M(!0))},r()}async function M(e=!1){const t=document.getElementById("comments-list"),n=document.getElementById("btn-load-more-comments");if(t&&!k){k=!0,e?(t.innerHTML=`
            <div class="flex flex-col items-center justify-center py-8 text-gray-500 animate-pulse">
                <i class="ri-loader-4-line text-2xl animate-spin mb-2"></i>
                <span class="text-xs">กำลังโหลดความคิดเห็น...</span>
            </div>`,n&&n.classList.add("hidden")):n&&(n.innerHTML='<i class="ri-loader-4-line animate-spin"></i> กำลังโหลด...',n.disabled=!0);try{const r=w(d,`artifacts/${m}/public/data/comments`);let o;if(y==="episode"){if(!U){t.innerHTML='<p class="text-gray-500 text-sm text-center py-4">ไม่พบข้อมูลตอน</p>',k=!1;return}o=b(r,h("episodeId","==",U),H("createdAt","desc"))}else o=b(r,h("showId","==",A),h("type","==","show"),H("createdAt","desc"));let s=b(o,$(20));!e&&x&&(s=b(o,fe(x),$(20)));const i=await B(s);if(e&&i.empty){const l=y==="episode"?"ยังไม่มีใครคุยเกี่ยวกับตอนนี้เลย":"ยังไม่มีการพูดคุยในภาพรวม";t.innerHTML=`
                <div class="text-center py-8">
                    <div class="bg-gray-800/50 inline-flex p-3 rounded-full mb-3 text-gray-500">
                        <i class="ri-chat-1-line text-2xl"></i>
                    </div>
                    <p class="text-gray-400 text-sm">${l}</p>
                    <p class="text-gray-600 text-xs mt-1">มาเริ่มเปิดประเด็นกันเถอะ!</p>
                </div>`,k=!1;return}e&&(t.innerHTML="");let a="";i.forEach(l=>{const c=l.data(),p=c.createdAt?ce(c.createdAt):"เมื่อสักครู่",v=y==="show"&&c.episodeNum?`<span class="bg-gray-700 text-gray-300 text-[10px] px-1.5 py-0.5 rounded ml-2">Ep.${c.episodeNum}</span>`:"",te=W(c.userName||"Guest"),ne=W(c.userPhoto)||"https://placehold.co/40x40?text=?",re=W(c.text);a+=`
                <div class="group flex gap-3 mb-4 border-b border-gray-800 pb-4 last:border-0 hover:bg-gray-800/30 p-2 rounded-lg transition-colors">
                    <img src="${ne}" class="w-10 h-10 rounded-full bg-gray-700 object-cover flex-shrink-0 shadow-sm">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center flex-wrap gap-y-1 mb-1">
                            <span class="font-bold text-sm text-green-400 mr-2">${te}</span>
                            <span class="text-xs text-gray-500">${p}</span>
                            ${v}
                        </div>
                        <p class="text-sm text-gray-200 whitespace-pre-line leading-relaxed">${re}</p>
                    </div>
                </div>
            `}),t.insertAdjacentHTML("beforeend",a),i.docs.length<20?(x=null,n&&n.classList.add("hidden")):(x=i.docs[i.docs.length-1],n&&(n.classList.remove("hidden"),n.innerHTML="โหลดความคิดเห็นเพิ่มเติม...",n.disabled=!1))}catch(r){if(console.error("Load comments error",r),r.message.includes("index")){const o=r.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);if(o){const s=`
                    <div class="text-center p-4 border border-yellow-600 bg-yellow-900/30 rounded-lg my-4">
                        <i class="ri-alert-line text-2xl text-yellow-500 mb-2 block"></i>
                        <p class="text-yellow-500 text-sm mb-2 font-bold">⚠️ จำเป็นต้องสร้าง Index ใหม่</p>
                        <a href="${o[0]}" target="_blank" class="inline-block bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-full text-xs font-bold transition-colors">คลิกสร้าง Index</a>
                    </div>`;e?t.innerHTML=s:t.insertAdjacentHTML("beforeend",s),n&&n.classList.add("hidden");return}}e&&(t.innerHTML=`<p class="text-red-500 text-sm text-center py-4">เกิดข้อผิดพลาด: ${r.message}</p>`)}finally{k=!1}}}async function Ue(e){if(!e||!A)return;const t=document.getElementById("comment-input"),n=t.value.trim();if(!n)return;const r=document.getElementById("btn-post-comment"),o=r.innerHTML;r.disabled=!0,r.innerHTML='<i class="ri-loader-4-line animate-spin"></i>';try{const s={userId:e.uid,userName:e.displayName||"User",userPhoto:e.photoURL||"",text:n,createdAt:q(),showId:A,episodeId:U||null,episodeNum:P||0,type:y};await Y(w(d,`artifacts/${m}/public/data/comments`),s),t.value="",x=null,await M(!0)}catch(s){console.error("Post comment error",s),alert("ส่งความคิดเห็นไม่สำเร็จ: "+s.message)}finally{r.disabled=!1,r.innerHTML=o}}function Pe(e){const t=document.getElementById("comment-login-prompt"),n=document.getElementById("comment-input-area"),r=document.getElementById("comment-user-avatar");!t||!n||(e?(t.classList.add("hidden"),n.classList.remove("hidden"),r&&(r.src=e.photoURL||"https://placehold.co/40x40")):(t.classList.remove("hidden"),n.classList.add("hidden")))}let R=null,u=null,_=null,E=[],N=!1;async function g(e){e&&(_=e,Z(e),be(u,e),R&&ke(R.uid,u,e),Te(u.id),ve(e.id),ee(e),Re(e.number),Se(u.id,e.id,e.number),window.scrollTo({top:0,behavior:"smooth"}))}function Re(e){const t=document.getElementById("prev-episode-btn"),n=document.getElementById("next-episode-btn"),r=u.latestEpisodeNumber||9999;t&&(t.disabled=e<=1),n&&(n.disabled=e>=r)}async function J(e){if(!_)return;const t=e==="next"?document.getElementById("next-episode-btn"):document.getElementById("prev-episode-btn");t.disabled=!0;try{const n=await Ee(_.number,e,u);n&&(await D(n.number,g),g(n))}catch(n){console.error(n)}finally{t.disabled=!1}}document.addEventListener("DOMContentLoaded",async()=>{var n;oe("silent"),await ae("..");const e=document.getElementById("loading-player"),t=document.getElementById("player-content-wrapper");document.getElementById("prev-episode-btn").onclick=()=>J("prev"),document.getElementById("next-episode-btn").onclick=()=>J("next"),(n=document.getElementById("btn-post-comment"))==null||n.addEventListener("click",()=>Ue(R)),se(ie,async r=>{R=r,Pe(r);const o=new URLSearchParams(window.location.search),s=o.get("id"),i=o.get("ep_id");if(!s){e.innerHTML='<p class="text-red-500">URL ไม่ถูกต้อง</p>';return}try{const a=await F(G(d,`artifacts/${m}/public/data/shows`,s));if(!a.exists())throw new Error("ไม่พบข้อมูลอนิเมะ");u={id:a.id,...a.data()},ye(u),r?(E=await Be(r.uid),N||(K(E),N=!0)):N||(K([]),N=!0);let l=i,c=1;if(!l&&E.length>0){const p=E.find(v=>v.showId===s);p&&(l=p.lastWatchedEpisodeId)}if(Le(r,u),He(r,u,()=>_),Me(u,E),Ce(E),l){const p=await F(G(d,`artifacts/${m}/public/data/episodes`,l));if(p.exists()){const v={id:p.id,...p.data()};c=v.number,await V(s,u.latestEpisodeNumber,g),await D(c,g),g(v)}else await V(s,u.latestEpisodeNumber,g),await D(1,g)}else{await V(s,u.latestEpisodeNumber,g);const p=await z(1,50,document.getElementById("episode-list-container"),g);p.length>0?g(p[0]):Z(null)}e.classList.add("hidden"),t.classList.remove("hidden")}catch(a){console.error(a),e.innerHTML=`<p class="text-red-500">เกิดข้อผิดพลาด: ${a.message}</p>`}}),window.addEventListener("popstate",()=>window.location.reload())});
