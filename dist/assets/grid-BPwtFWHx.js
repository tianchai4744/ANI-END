import{q as m,w as M,l as x,j as k,g as E,c as B,s as R,o as U,k as z,b as A,f as $,a as D,d as S}from"./db-config-JzEx42YR.js";import{c as _}from"./card-DUAddn7M.js";import{s as j}from"./search-CnOzQKex.js";import{l as Q}from"./navbar-DtgS--Xs.js";import{g as V}from"./tools-Cv2G4J4g.js";import"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const p=28;let F,g="tag",N="",y=null,I=[],b={},h=new Set,v=new Set,w=!1,r=!0,C=[],H=!1,T,c,o,d;async function q(){R("silent"),U(A,async t=>{t?(F=t.uid,await O(),H||(j(C),H=!0),P()):await z(A)})}function G(t){return $(S,`artifacts/${D}/public/data/${t}`)}async function O(){try{const t=m($(S,`artifacts/${D}/users/${F}/viewHistory`),B("watchedAt","desc"),x(50));C=(await E(t)).docs.map(a=>({id:a.id,...a.data()}))}catch(t){console.error("History Error",t)}}function P(){const t=new URLSearchParams(window.location.search),l=t.get("search"),a=t.get("tag");if(y=null,b={},h.clear(),I=[],r=!0,v.clear(),c.innerHTML="",o.classList.add("hidden"),l){const s=decodeURIComponent(l);g="search",I=V(s),T.textContent=`ผลการค้นหา "${s}"`,document.title=`ค้นหา: ${s} | ANI-END`;const e=document.getElementById("search-input"),n=document.getElementById("mobile-search-input");e&&(e.value=s),n&&(n.value=s),L()}else{const s=a?decodeURIComponent(a):"อนิเมะ";g="tag",N=s,T.textContent=s,document.title=`${s} | ANI-END`;const e=document.getElementById("search-input");e&&(e.value=""),L()}}function Y(t=14){let l="";for(let a=0;a<t;a++)l+=`
                <div class="block rounded-lg overflow-hidden relative">
                    <div class="aspect-[2/3] bg-gray-800 skeleton w-full h-full rounded-lg mb-2"></div>
                    <div class="h-4 bg-gray-800 skeleton w-3/4 rounded mb-1"></div>
                </div>`;return l}async function L(){if(w||!r)return;w=!0;const t=v.size===0;t?c.innerHTML=Y(14):(o.textContent="กำลังโหลด...",o.disabled=!0);try{const l=G("shows");let a=[];if(g==="search"){const e=I.map(async i=>{if(h.has(i))return[];let u=m(l,M("keywords","array-contains",i),x(p));b[i]&&(u=m(u,k(b[i])));const f=await E(u);return f.empty?(h.add(i),[]):(b[i]=f.docs[f.docs.length-1],f.docs.length<p&&h.add(i),f.docs)});a=(await Promise.all(e)).flat(),h.size===I.length&&(r=!1)}else{let e=m(l,M("tags","array-contains",N),B("updatedAt","desc"),x(p));y&&(e=m(e,k(y)));const n=await E(e);n.empty?r=!1:(a=n.docs,y=n.docs[n.docs.length-1],n.docs.length<p&&(r=!1))}t&&(c.innerHTML="");const s=[];if(a.forEach(e=>{v.has(e.id)||(v.add(e.id),s.push(e))}),s.length>0){g==="search"&&s.sort((n,i)=>(n.data().title||"").localeCompare(i.data().title||""));let e="";s.forEach((n,i)=>{e+=_({id:n.id,...n.data()},null,C.find(u=>u.showId===n.id))}),c.insertAdjacentHTML("beforeend",e),r?(o.classList.remove("hidden"),o.textContent="โหลดเพิ่มเติม...",o.disabled=!1):o.classList.add("hidden")}else{if(t){const e=g==="search"?"ไม่พบผลลัพธ์การค้นหา":"ไม่พบข้อมูลในหมวดนี้";c.innerHTML=`<p class="text-center w-full col-span-full text-gray-400 py-10">${e}</p>`}if(r||o.classList.add("hidden"),r&&s.length===0){w=!1,L();return}}}catch(l){console.error("Fetch Error:",l);const a=l.message.includes("index");if(t)if(a){const s=l.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/),e=s?`<a href="${s[0]}" target="_blank" class="text-yellow-400 underline block mt-2">คลิกเพื่อสร้าง Index</a>`:"";c.innerHTML=`<div class="col-span-full text-center p-6 border border-yellow-600 bg-yellow-900/20 text-yellow-500">ระบบต้องการ Index สำหรับการค้นหานี้ ${e}</div>`}else c.innerHTML='<p class="text-center w-full col-span-full text-red-500">เกิดข้อผิดพลาดในการโหลด</p>'}finally{w=!1,r&&o&&(o.disabled=!1,o.textContent="โหลดเพิ่มเติม...")}}document.addEventListener("DOMContentLoaded",async()=>{await Q(".."),document.getElementById("grid-view-container"),T=document.getElementById("grid-view-title"),c=document.getElementById("grid-view-content"),o=document.getElementById("load-more-btn"),d=document.createElement("button"),d.innerHTML='<i class="ri-arrow-up-line text-2xl"></i>',d.className="scroll-to-top fixed bottom-8 right-8 bg-green-600 text-white p-3 rounded-full shadow-lg cursor-pointer hover:bg-green-700 z-50",d.onclick=()=>window.scrollTo({top:0,behavior:"smooth"}),document.body.appendChild(d),window.addEventListener("scroll",()=>d.classList.toggle("visible",window.scrollY>300)),window.addEventListener("popstate",P),o&&o.addEventListener("click",L),q()});
