import{collection as $,getDocs as E,query as I,where as w,limit as k}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import{d as S,a as T}from"./db-config-JzEx42YR.js";import{d as M,g as B}from"./tools-Cv2G4J4g.js";function P(v=[],g=5){const s=document.getElementById("search-input"),n=document.getElementById("search-dropdown"),a=document.getElementById("mobile-search-input"),o=document.getElementById("mobile-search-dropdown"),u=()=>{const e=window.location.pathname.includes("/pages/");return{player:e?"player.html":"pages/player.html",grid:e?"grid.html":"pages/grid.html"}},x=async(e,t)=>{if(!e||e.length<2){t.classList.add("hidden"),t.innerHTML="";return}t.innerHTML='<div class="p-4 text-center text-gray-400"><i class="ri-loader-4-line animate-spin"></i> กำลังค้นหา...</div>',t.classList.remove("hidden");try{const d=B(e),l=$(S,`artifacts/${T}/public/data/shows`),h=d.map(p=>E(I(l,w("keywords","array-contains",p),k(g)))),m=await Promise.all(h),r=new Map;m.forEach(p=>{p.forEach(c=>{r.has(c.id)||r.set(c.id,{id:c.id,...c.data()})})});const i=Array.from(r.values()).slice(0,g);b(i,t,v)}catch(d){console.error("Search Error:",d),t.innerHTML='<div class="p-3 text-center text-red-400 text-sm">เกิดข้อผิดพลาด</div>'}},b=(e,t,d)=>{if(e.length===0){t.innerHTML='<div class="p-3 text-center text-gray-500 text-sm">ไม่พบข้อมูล</div>';return}const l=u();let h="";e.forEach(r=>{const i=d.find(L=>L.showId===r.id),p=i&&i.lastWatchedEpisodeId?`${l.player}?id=${r.id}&ep_id=${i.lastWatchedEpisodeId}`:`${l.player}?id=${r.id}`,c=i?'<span class="text-[10px] bg-green-900 text-green-300 px-1.5 py-0.5 rounded ml-2">เคยดู</span>':"";h+=`
                <a href="${p}" class="search-dropdown-item block p-3 border-b border-gray-700 last:border-0 flex items-center gap-3 transition-colors">
                    <img src="${r.thumbnailUrl}" class="w-10 h-14 object-cover rounded bg-gray-700 flex-shrink-0" onerror="this.src='https://placehold.co/40x60?text=?'">
                    <div class="min-w-0">
                        <h4 class="text-sm font-bold text-white truncate">${r.title} ${c}</h4>
                        <p class="text-xs text-gray-400 truncate">ตอนที่ ${r.latestEpisodeNumber||0}</p>
                    </div>
                </a>
            `});const m=s?s.value:a?a.value:"";h+=`
            <a href="${l.grid}?search=${encodeURIComponent(m)}" class="block p-3 text-center text-sm text-green-400 hover:text-green-300 bg-gray-800 hover:bg-gray-700 font-medium transition-colors">
                ดูผลการค้นหาทั้งหมด (${e.length}+)
            </a>
        `,t.innerHTML=h},f=M((e,t)=>x(e.target.value,t),400),y=e=>{if(e.key==="Enter"&&e.target.value.trim()){const t=u();window.location.href=`${t.grid}?search=${encodeURIComponent(e.target.value.trim())}`}};s&&n&&(s.addEventListener("input",e=>f(e,n)),s.addEventListener("focus",e=>{e.target.value&&n.classList.remove("hidden")}),s.addEventListener("keyup",y)),a&&o&&(a.addEventListener("input",e=>f(e,o)),a.addEventListener("keyup",y)),document.addEventListener("click",e=>{s&&n&&!s.contains(e.target)&&!n.contains(e.target)&&n.classList.add("hidden"),a&&o&&!a.contains(e.target)&&!o.contains(e.target)&&o.classList.add("hidden")})}export{P as s};
