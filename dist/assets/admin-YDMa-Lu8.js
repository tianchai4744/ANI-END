import{d as ie,f as N,h as H,i as f,q as d,l as h,w as y,g as v,B as X,k as E,u as C,p as j,n as R,b as S,j as I,C as U,c as se,s as de,o as ce,e as le,a as F,A as ne,G as ue,v as me}from"./db-config-CDOV0zmd.js";import{a as he,f as K,d as pe}from"./tools-BcGrSTdy.js";function c(e){return ie(N,e)}function u(e,t="success"){const s=document.getElementById("toast-container");if(!s)return;const n=document.createElement("div"),r=t==="error"?"bg-red-600":"bg-emerald-600";n.className=`${r} text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0`,n.innerHTML=`
        <i class="${t==="error"?"fas fa-exclamation-circle":"fas fa-check-circle"}"></i>
        <span class="font-medium">${e}</span>
    `,s.appendChild(n),requestAnimationFrame(()=>{n.classList.remove("translate-y-10","opacity-0")}),setTimeout(()=>{n.classList.add("opacity-0","translate-y-10"),setTimeout(()=>n.remove(),300)},3e3)}function g(e,t="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."){const s=document.getElementById("global-loading"),n=document.getElementById("loading-text");s&&(e?s.classList.remove("hidden"):s.classList.add("hidden")),e&&n&&t&&(n.textContent=t)}function k(e,t,s){const n="dynamic-confirm-modal";let r=document.getElementById(n);r&&r.remove();const o=`
    <div id="${n}" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-[#1e293b] w-full max-w-sm rounded-2xl shadow-2xl border border-gray-700 p-6 transform scale-95 animate-scale-up">
            <h3 class="text-xl font-bold text-white mb-2">${e}</h3>
            <p class="text-gray-400 mb-6 text-sm">${t}</p>
            <div class="flex justify-end gap-3">
                <button id="btn-cancel-modal" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-confirm-modal" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-bold shadow-lg transition-colors">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>`;document.body.insertAdjacentHTML("beforeend",o),document.getElementById("btn-cancel-modal").onclick=()=>document.getElementById(n).remove(),document.getElementById("btn-confirm-modal").onclick=async()=>{document.getElementById(n).remove(),s&&await s()}}const D={cursors:[null],currentPage:1,currentSort:{field:"updatedAt",dir:"desc"},resetPagination(){this.currentPage=1,this.cursors=[null]},toggleSort(e){this.currentSort.field===e?this.currentSort.dir=this.currentSort.dir==="asc"?"desc":"asc":(this.currentSort.field=e,this.currentSort.dir="desc")},async fetchList(e="reset",t=""){const n=c("shows");let r,o=d(n,S(this.currentSort.field,this.currentSort.dir));if(t)r=d(n,y("keywords","array-contains",t),h(20)),this.resetPagination();else if(e==="reset")this.resetPagination(),r=d(o,h(20));else if(e==="next"){const i=this.cursors[this.currentPage];r=i?d(o,I(i),h(20)):d(o,h(20)),i&&this.currentPage++}else if(e==="prev"){if(this.currentPage>1){this.currentPage--;const i=this.cursors[this.currentPage-1];r=i?d(o,I(i),h(20)):d(o,h(20))}}else if(e==="current"){const i=this.cursors[this.currentPage-1];r=i?d(o,I(i),h(20)):d(o,h(20))}const a=await v(r);return a.empty&&e!=="reset"&&this.currentPage>1?(this.currentPage--,await this.fetchList("current")):(a.docs.length===20&&(this.cursors[this.currentPage]=a.docs[a.docs.length-1]),{items:a.docs.map(i=>({id:i.id,...i.data()})),page:this.currentPage,hasNext:a.docs.length===20,hasPrev:this.currentPage>1})},async fetchById(e){const t=await R(f(c("shows"),e));return t.exists()?{id:t.id,...t.data()}:null},async save(e,t){t.updatedAt=E(),t.keywords=he(t.title),e?await C(f(c("shows"),e),t):(t.createdAt=E(),t.latestEpisodeNumber=0,t.episodeCount=0,await j(c("shows"),t))},async deleteBatches(e,t,s){let r=!0,o=0;for(;r;){const a=d(c(e),y(t,"==",s),h(400)),i=await v(a);if(i.empty){r=!1;break}const m=X(N);i.docs.forEach(l=>m.delete(l.ref)),await m.commit(),o+=i.size,g(!0,`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö ${e}... (${o})`)}},async deleteFull(e){await this.deleteBatches("episodes","showId",e),await this.deleteBatches("banners","showId",e),await this.deleteBatches("reports","showId",e),await this.deleteBatches("comments","showId",e),await H(f(c("shows"),e))}},_={renderTable(e,t){const s=document.getElementById("show-table-body");if(s){if(s.innerHTML="",e.length===0){s.innerHTML='<tr><td colspan="5" class="text-center py-10 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';return}e.forEach(n=>{const r=document.createElement("tr");r.className="border-b border-gray-700 hover:bg-gray-800 transition-colors",r.innerHTML=`
                <td class="px-6 py-4 flex items-center gap-3">
                    <img src="${n.thumbnailUrl}" class="w-10 h-10 object-cover rounded bg-gray-700" onerror="this.src='https://placehold.co/40x40?text=?'">
                    <div class="flex flex-col">
                        <span class="truncate max-w-xs text-white cursor-help" title="${n.title}">${n.title}</span>
                        <span class="text-xs text-gray-500">${(n.tags||[]).slice(0,3).join(", ")}</span>
                    </div>
                </td>
                <td class="px-6 py-4 text-gray-300 text-center font-medium">${n.latestEpisodeNumber||0}</td>
                <td class="px-6 py-4 text-gray-300 text-center font-medium">${n.viewCount||0}</td>
                <td class="px-6 py-4 text-gray-400 text-center text-sm font-mono">${K(n.updatedAt)}</td>
                <td class="px-6 py-4 text-right space-x-2 whitespace-nowrap">
                    <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded text-xs btn-manage transition-colors" data-id="${n.id}"><i class="fas fa-list-ol"></i> ‡∏ï‡∏≠‡∏ô</button>
                    <button class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-gray-300 btn-edit transition-colors" data-id="${n.id}"><i class="fas fa-edit"></i></button>
                    <button class="bg-red-900/30 hover:bg-red-900/50 p-2 rounded text-red-400 btn-del transition-colors" data-id="${n.id}"><i class="fas fa-trash"></i></button>
                </td>
            `,s.appendChild(r)}),s.querySelectorAll(".btn-manage").forEach(n=>n.onclick=()=>t("manage",n.dataset.id)),s.querySelectorAll(".btn-edit").forEach(n=>n.onclick=()=>t("edit",n.dataset.id)),s.querySelectorAll(".btn-del").forEach(n=>n.onclick=()=>t("delete",n.dataset.id))}},updatePagination(e,t,s){const n=document.getElementById("page-info-show"),r=document.getElementById("next-page-show"),o=document.getElementById("prev-page-show");n&&(n.textContent=`‡∏´‡∏ô‡πâ‡∏≤ ${e}`),r&&(r.disabled=!t),o&&(o.disabled=!s)},openModal(e=null){const t=document.getElementById("show-modal"),s=document.getElementById("show-form");s.reset(),s.dataset.id=e?e.id:"",document.querySelectorAll(".show-tag-option").forEach(n=>n.checked=!1),e&&(document.getElementById("show-title").value=e.title,document.getElementById("show-desc").value=e.description||"",document.getElementById("show-thumbnail").value=e.thumbnailUrl,document.getElementById("show-view-count").value=e.viewCount||0,document.getElementById("show-completed").checked=e.isCompleted||!1,e.tags&&Array.isArray(e.tags)&&e.tags.forEach(n=>{const r=document.querySelector(`.show-tag-option[value="${n}"]`);r&&(r.checked=!0)})),t.classList.remove("hidden"),t.classList.add("flex")},closeModal(){const e=document.getElementById("show-modal");e.classList.add("hidden"),e.classList.remove("flex")}};function ge(){const e=document.getElementById("btn-search-show");if(e){const o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.onclick=()=>L(!0)}const t=document.getElementById("btn-reset-show");if(t){const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.onclick=()=>{document.getElementById("search-show").value="",L(!1)}}const s=document.getElementById("show-form");s&&(s.onsubmit=fe);const n=document.getElementById("next-page-show"),r=document.getElementById("prev-page-show");n&&(n.onclick=()=>Z("next")),r&&(r.onclick=()=>Z("prev")),window.openShowModal=o=>re(o),window.sortShows=o=>{D.toggleSort(o),L(!1)},L()}async function Z(e="reset"){g(!0,"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");try{const t=document.getElementById("search-show"),s=t?t.value.trim().toLowerCase():"",n=await D.fetchList(e,s);_.renderTable(n.items,(r,o)=>{r==="manage"&&be(o),r==="edit"&&re(o),r==="delete"&&ye(o)}),_.updatePagination(n.page,n.hasNext,n.hasPrev)}catch(t){console.error(t),u("Error: "+t.message,"error")}finally{g(!1)}}async function L(e=!1){await Z("reset")}async function re(e=null){if(e){g(!0,"‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");try{const t=await D.fetchById(e);t?_.openModal(t):u("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•","error")}catch(t){console.error(t)}finally{g(!1)}}else _.openModal()}async function fe(e){e.preventDefault();const t=e.submitter||e.target.querySelector('button[type="submit"]');if(!(t&&t.disabled)){g(!0,"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."),t&&(t.disabled=!0);try{const s=e.target.dataset.id,n=Array.from(document.querySelectorAll(".show-tag-option:checked")).map(o=>o.value);n.length===0&&n.push("‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞");const r={title:document.getElementById("show-title").value.trim(),description:document.getElementById("show-desc").value,thumbnailUrl:document.getElementById("show-thumbnail").value,viewCount:parseInt(document.getElementById("show-view-count").value)||0,isCompleted:document.getElementById("show-completed").checked,tags:n};await D.save(s,r),u("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),_.closeModal(),L()}catch(s){u(s.message,"error")}finally{g(!1),t&&(t.disabled=!1)}}}async function ye(e){k("‡∏•‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£",async()=>{g(!0,"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...");try{await D.deleteFull(e),u("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),L(),window.fetchDashboardStats&&window.fetchDashboardStats()}catch(t){console.error(t),u("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+t.message,"error")}finally{g(!1)}})}function be(e){window.switchTab("episodes");const t=document.getElementById("filter-episode-show");if(t){t.value=e;const s=document.getElementById("btn-load-episodes");s&&s.click()}}const P={cursors:[null],currentPage:1,currentSort:"desc",resetPagination(){this.currentPage=1,this.cursors=[null]},toggleSort(){return this.currentSort=this.currentSort==="desc"?"asc":"desc",this.currentSort},async fetchList(e,t="reset",s=null){const r=c("episodes");let o;if(t==="search_number"&&s)return o=d(r,y("showId","==",e),y("number","==",parseFloat(s))),{items:(await v(o)).docs.map(l=>({id:l.id,...l.data()})),isSearch:!0};const a=d(r,y("showId","==",e),S("number",this.currentSort));if(t==="reset")this.resetPagination(),o=d(a,h(50));else if(t==="next"){const m=this.cursors[this.currentPage];o=m?d(a,I(m),h(50)):d(a,h(50)),m&&this.currentPage++}else if(t==="prev"){if(this.currentPage>1){this.currentPage--;const m=this.cursors[this.currentPage-1];o=m?d(a,I(m),h(50)):d(a,h(50))}}else if(t==="current"){const m=this.cursors[this.currentPage-1];o=m?d(a,I(m),h(50)):d(a,h(50))}const i=await v(o);return i.docs.length===50&&(this.cursors[this.currentPage]=i.docs[i.docs.length-1]),{items:i.docs.map(m=>({id:m.id,...m.data()})),page:this.currentPage,hasNext:i.docs.length===50,hasPrev:this.currentPage>1,isSearch:!1}},async fetchShows(e=""){let t;return e?t=d(c("shows"),y("title",">=",e),y("title","<=",e+"Ô£ø"),h(20)):t=d(c("shows"),S("updatedAt","desc"),h(50)),(await v(t)).docs.map(s=>({id:s.id,title:s.data().title,latestEpisodeNumber:s.data().latestEpisodeNumber||0}))},async getShowTitle(e){if(!e)return"Unknown";try{const t=await R(f(c("shows"),e));return t.exists()?t.data().title:"Unknown Show"}catch{return"Error Loading Title"}},async checkDuplicate(e,t,s=null){const n=d(c("episodes"),y("showId","==",e),y("number","==",t)),r=await v(n);return!(r.empty||s&&r.docs.length===1&&r.docs[0].id===s)},async save(e,t){if(await this.checkDuplicate(t.showId,t.number,e))throw new Error(`‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${t.number} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß!`);t.updatedAt=E(),e?await C(f(c("episodes"),e),t):(t.createdAt=E(),await j(c("episodes"),t)),await this.recalculateStats(t.showId)},async saveBulk(e,t){for(let n=0;n<e.length;n+=400){const r=X(N);e.slice(n,n+400).forEach(a=>{const i=f(c("episodes"));r.set(i,a)}),await r.commit()}await this.recalculateStats(t)},async delete(e){const t=f(c("episodes"),e),s=await R(t);if(s.exists()){const{showId:n}=s.data();return await H(t),await this.recalculateStats(n),n}return null},async recalculateStats(e){if(e)try{const t=c("episodes"),s=d(t,y("showId","==",e),S("number","desc"),h(1)),n=await v(s),r=n.empty?0:n.docs[0].data().number,o=d(t,y("showId","==",e)),a=await U(o);await C(f(c("shows"),e),{latestEpisodeNumber:r,episodeCount:a.data().count,latestEpisodeUpdateAt:E(),updatedAt:E()})}catch(t){console.error("Recalculate Error:",t)}}},b={allShowOptions:[],injectSearch(e){const t=document.getElementById("btn-sort-episodes");if(t&&!document.getElementById("search-ep-number")){const s=document.createElement("div");s.className="relative",s.innerHTML=`
                <input type="number" id="search-ep-number" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà..." 
                    class="bg-gray-900 border border-gray-700 rounded-lg py-2.5 px-3 text-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 w-32">
                <button id="btn-search-ep-number" class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1.5"><i class="fas fa-search"></i></button>
            `,t.parentNode.insertBefore(s,t);const n=s.querySelector("input"),r=s.querySelector("button"),o=()=>e(n.value.trim());r.addEventListener("click",o),n.addEventListener("keyup",a=>{a.key==="Enter"&&o(),a.key==="Backspace"&&n.value===""&&e("")})}},setupDropdowns(e){[{select:document.getElementById("episode-show-select"),id:"search-ep-show"},{select:document.getElementById("filter-episode-show"),id:"search-filter-show"},{select:document.getElementById("bulk-episode-show-select"),id:"search-bulk-show"}].forEach(({select:s,id:n})=>{if(!s||s.parentNode.querySelector("input"))return;const r=document.createElement("div");r.className="space-y-1 mb-2 searchable-wrapper";const o=document.createElement("input");o.type="text",o.id=n,o.placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á...",o.className="block w-full bg-gray-800 border border-gray-600 rounded-lg text-xs py-1.5 px-3 text-gray-300 mb-1 focus:ring-1 focus:ring-indigo-500",s.parentNode.insertBefore(r,s),r.appendChild(o),r.appendChild(s),o.addEventListener("input",pe(a=>e(a.target.value.trim()),500))})},updateDropdowns(e,t=""){t||(this.allShowOptions=e),["filter-episode-show","episode-show-select","bulk-episode-show-select"].forEach(s=>{const n=document.getElementById(s);if(!n)return;const r=n.value;let o='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞ --</option>';if(e.forEach(a=>o+=`<option value="${a.id}">${a.title}</option>`),n.innerHTML=o,r){if(!e.find(i=>i.id===r)){const i=this.allShowOptions.find(m=>m.id===r);i&&this.addOption(s,i.id,i.title,!0)}n.value=r}})},addOption(e,t,s,n=!1){const r=document.getElementById(e);if(r&&!r.querySelector(`option[value="${t}"]`)){const o=document.createElement("option");o.value=t,o.textContent=s,n&&(o.selected=!0),r.appendChild(o)}},renderTable(e,t,s){const n=document.getElementById("episode-table-body");if(n.innerHTML="",e.length===0){n.innerHTML='<tr><td colspan="4" class="text-center py-10 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô</td></tr>';return}e.forEach(r=>{const o=document.createElement("tr");o.className="hover:bg-gray-700/50 transition-colors border-b border-gray-700/50",o.innerHTML=`
                <td class="px-6 py-4 text-sm font-medium text-white">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${r.number}</td>
                <td class="px-6 py-4 text-sm text-gray-300">${r.title||"-"}</td>
                <td class="px-6 py-4 text-sm text-gray-400">${K(r.updatedAt)}</td>
                <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                    <button class="btn-edit text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-all" data-id="${r.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn-del text-red-400 hover:text-red-300 bg-red-900/20 hover:bg-red-900/40 p-1.5 rounded-md transition-all" data-id="${r.id}"><i class="fas fa-trash"></i></button>
                </td>
            `,n.appendChild(o)}),n.querySelectorAll(".btn-edit").forEach(r=>r.onclick=()=>t(r.dataset.id)),n.querySelectorAll(".btn-del").forEach(r=>r.onclick=()=>s(r.dataset.id))},renderPagination(e,t,s,n){const r=document.getElementById("next-page-ep"),o=document.getElementById("prev-page-ep"),a=document.getElementById("page-info-ep"),i=document.getElementById("episode-pagination");n?i&&i.classList.add("hidden"):(i&&i.classList.remove("hidden"),a&&(a.textContent=`‡∏´‡∏ô‡πâ‡∏≤ ${e}`),r&&(r.disabled=!t),o&&(o.disabled=!s))},renderError(e){const t=document.getElementById("episode-table-body");if(e.message.includes("index")){const s=e.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);t.innerHTML=`<tr><td colspan="4" class="text-center py-6"><div class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-4 inline-block max-w-2xl"><i class="fas fa-exclamation-triangle text-2xl text-yellow-500 mb-1"></i><br><span class="font-bold text-yellow-100">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Index ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span><br>${s?`<a href="${s[0]}" target="_blank" class="text-yellow-400 underline">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á Index</a>`:""}</div></td></tr>`}else t.innerHTML=`<tr><td colspan="4" class="text-center py-4 text-red-400">Error: ${e.message}</td></tr>`},openModal(e,t,s){const n=document.getElementById("episode-form");n.reset(),n.dataset.id=e||"";const r=document.getElementById("search-ep-show");r&&(r.value=""),document.getElementById("episode-modal").classList.remove("hidden"),document.getElementById("episode-modal").classList.add("flex")},closeModal(e){const t=document.getElementById(e);t.classList.add("hidden"),t.classList.remove("flex")}};let w=null,Q=[],A=!1;function we(){var s,n,r,o,a,i,m;b.injectSearch(l=>B("search_number",l)),(s=document.getElementById("btn-load-episodes"))==null||s.addEventListener("click",()=>B("reset")),(n=document.getElementById("episode-form"))==null||n.addEventListener("submit",Ee),(r=document.getElementById("btn-submit-bulk"))==null||r.addEventListener("click",xe),(o=document.getElementById("next-page-ep"))==null||o.addEventListener("click",()=>B("next")),(a=document.getElementById("prev-page-ep"))==null||a.addEventListener("click",()=>B("prev"));const e=document.getElementById("btn-sort-episodes");e&&e.addEventListener("click",()=>{const l=P.toggleSort(),p=e.querySelector("i");p.className=l==="asc"?"fas fa-sort-numeric-down text-emerald-400":"fas fa-sort-numeric-up-alt",B("reset")}),b.setupDropdowns(l=>Y(l)),Y();const t=(l,p)=>{const x=l.target.value,q=b.allShowOptions.find(ae=>ae.id===x);q&&(document.getElementById(p).value=(q.latestEpisodeNumber||0)+1)};(i=document.getElementById("episode-show-select"))==null||i.addEventListener("change",l=>{document.getElementById("episode-form").dataset.id||t(l,"episode-number")}),(m=document.getElementById("bulk-episode-show-select"))==null||m.addEventListener("change",l=>t(l,"bulk-start-ep")),window.openEpisodeModal=async l=>{if(b.openModal(l,Q,w),l){const p=Q.find(x=>x.id===l);if(p){const x=document.getElementById("episode-show-select");if(!x.querySelector(`option[value="${p.showId}"]`)){const q=await P.getShowTitle(p.showId);b.addOption("episode-show-select",p.showId,q)}x.value=p.showId,document.getElementById("episode-number").value=p.number,document.getElementById("episode-title").value=p.title||"",document.getElementById("episode-url").value=p.videoUrl||""}}else if(w){const p=document.getElementById("episode-show-select");p.value=w,p.dispatchEvent(new Event("change"))}},window.openBulkEpisodeModal=()=>{const l=b.allShowOptions.find(x=>x.id===w);b.openModal("bulk-episode-modal");const p=document.getElementById("bulk-urls");if(p.value="",document.getElementById("search-bulk-show").value="",w){const x=document.getElementById("bulk-episode-show-select");x.value=w,l&&(document.getElementById("bulk-start-ep").value=(l.latestEpisodeNumber||0)+1)}document.getElementById("bulk-episode-modal").classList.remove("hidden"),document.getElementById("bulk-episode-modal").classList.add("flex")},window.deleteEpisode=ve}async function Y(e=""){const t=await P.fetchShows(e);b.updateDropdowns(t,e)}async function B(e="reset",t=null){var o;const s=document.getElementById("filter-episode-show").value;if(!s){u("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞‡∏Å‡πà‡∏≠‡∏ô","error");return}g(!0,"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô..."),w!==s&&e!=="reset"&&(e="reset"),w=s;const n=document.getElementById("filter-episode-show"),r=((o=n.options[n.selectedIndex])==null?void 0:o.text)||"Unknown";document.getElementById("episodes-header-title").textContent=`‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô: ${r}`,document.getElementById("btn-back-to-shows").classList.remove("hidden");try{const a=await P.fetchList(s,e,t);Q=a.items,b.renderTable(a.items,i=>window.openEpisodeModal(i),i=>window.deleteEpisode(i)),b.renderPagination(a.page,a.hasNext,a.hasPrev,a.isSearch)}catch(a){console.error(a),b.renderError(a)}finally{g(!1)}}async function Ee(e){if(e.preventDefault(),A)return;const t=e.target.dataset.id,s=document.getElementById("episode-show-select").value,n=parseFloat(document.getElementById("episode-number").value);if(!s){u("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞","error");return}A=!0,g(!0);try{const r={showId:s,number:n,title:document.getElementById("episode-title").value.trim(),videoUrl:document.getElementById("episode-url").value.trim()};await P.save(t,r),u("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"),b.closeModal("episode-modal"),w===s&&B("current")}catch(r){u(r.message,"error")}finally{A=!1,g(!1)}}async function xe(){if(A)return;const e=document.getElementById("bulk-episode-show-select").value,t=document.getElementById("bulk-urls").value.trim().split(`
`).filter(n=>n.trim()!=="");let s=parseFloat(document.getElementById("bulk-start-ep").value);if(!e||t.length===0){u("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô","error");return}k("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô",`‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° ${t.length} ‡∏ï‡∏≠‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ô ${s}?`,async()=>{A=!0,g(!0,"‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...");try{const n=c("episodes"),r=d(n,y("showId","==",e),y("number",">=",s)),o=await v(r),a=new Set(o.docs.map(p=>p.data().number));let i=[],m=s,l=0;if(t.forEach(p=>{a.has(m)?l++:i.push({showId:e,number:m,title:`‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${m}`,videoUrl:p.trim(),createdAt:E(),updatedAt:E()}),m++}),i.length===0){u(`‡∏ó‡∏∏‡∏Å‡∏ï‡∏≠‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (${l} ‡∏ï‡∏≠‡∏ô)`,"error");return}if(l>0&&!confirm(`‚ö†Ô∏è ‡∏û‡∏ö‡∏ï‡∏≠‡∏ô‡∏ã‡πâ‡∏≥ ${l} ‡∏ï‡∏≠‡∏ô! ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${i.length} ‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà?`))return;g(!0,`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${i.length} ‡∏ï‡∏≠‡∏ô...`),await P.saveBulk(i,e),u(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${i.length} ‡∏ï‡∏≠‡∏ô`),b.closeModal("bulk-episode-modal"),w===e&&B("current")}catch(n){u(n.message,"error")}finally{A=!1,g(!1)}})}async function ve(e){k("‡∏•‡∏ö‡∏ï‡∏≠‡∏ô","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?",async()=>{g(!0,"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...");try{const t=await P.delete(e);u("‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"),t===w&&B("current")}catch(t){u(t.message,"error")}finally{g(!1)}})}const O={unsubscribe:null,subscribe(e){this.unsubscribe&&this.unsubscribe();const t=d(c("banners"),S("order"));this.unsubscribe=se(t,s=>{const n=s.docs.map(r=>({id:r.id,...r.data()}));e(n)},s=>{console.error("Banner Listener Error:",s),u("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß","error")})},async save(e,t){if(t.updatedAt=E(),t.linkUrl&&t.linkUrl.includes("id="))try{const n=new URLSearchParams(t.linkUrl.split("?")[1]).get("id");n&&(t.showId=n)}catch{}e?await C(f(c("banners"),e),t):(t.createdAt=E(),await j(c("banners"),t))},async delete(e){await H(f(c("banners"),e))},async reorder(e){const t=X(N);e.forEach((s,n)=>{t.update(f(c("banners"),s),{order:n+1})}),await t.commit()}},M={tbody:null,drake:null,currentBanners:[],init(e){this.tbody=document.getElementById("banner-table-body"),typeof window.dragula<"u"&&this.tbody&&(this.drake?this.drake.containers=[this.tbody]:(this.drake=window.dragula([this.tbody]),this.drake.on("drop",()=>{const t=Array.from(this.tbody.children).map(s=>s.dataset.id);e(t)})))},renderTable(e,t,s){this.tbody&&(this.currentBanners=e,this.tbody.innerHTML="",e.forEach(n=>{const r=document.createElement("tr");r.className="border-b border-gray-700 hover:bg-gray-800 transition-colors cursor-move",r.dataset.id=n.id,r.innerHTML=`
                <td class="px-6 py-4"><img src="${n.imageUrl}" class="h-10 rounded object-cover bg-gray-700" onerror="this.src='https://placehold.co/100x40?text=No+Img'"></td>
                <td class="px-6 py-4 text-white">${n.title} ${n.isActive?'<span class="text-emerald-400 text-xs ml-1">(Active)</span>':""}</td>
                <td class="px-6 py-4 text-gray-300">${n.order}</td>
                <td class="px-6 py-4 text-right">
                    <button class="btn-edit text-gray-400 hover:text-white mr-2" data-id="${n.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn-del text-red-400 hover:text-red-300 bg-red-900/20 hover:bg-red-900/40 p-2 rounded transition-colors" data-id="${n.id}"><i class="fas fa-trash"></i></button>
                </td>
            `,this.tbody.appendChild(r)}),this.tbody.querySelectorAll(".btn-edit").forEach(n=>n.onclick=()=>t(n.dataset.id)),this.tbody.querySelectorAll(".btn-del").forEach(n=>n.onclick=()=>s(n.dataset.id)))},openModal(e=null){const t=document.getElementById("banner-form");if(t.reset(),t.dataset.id=e||"",e){const s=this.currentBanners.find(n=>n.id===e);s&&(document.getElementById("banner-title").value=s.title,document.getElementById("banner-image-url").value=s.imageUrl,document.getElementById("banner-link-url").value=s.linkUrl||"",document.getElementById("banner-order").value=s.order,document.getElementById("banner-active").checked=s.isActive)}else document.getElementById("banner-order").value=this.currentBanners.length+1;document.getElementById("banner-modal").classList.remove("hidden"),document.getElementById("banner-modal").classList.add("flex")},closeModal(){document.getElementById("banner-modal").classList.add("hidden"),document.getElementById("banner-modal").classList.remove("flex")}};function Ie(){M.init(async t=>{await O.reorder(t),u("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")}),O.subscribe(t=>{M.renderTable(t,s=>M.openModal(s),s=>Se(s))});const e=document.getElementById("banner-form");if(e){const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("submit",Be)}window.openBannerModal=t=>M.openModal(t)}async function Be(e){e.preventDefault();const t=e.target.dataset.id,s={title:document.getElementById("banner-title").value,imageUrl:document.getElementById("banner-image-url").value,linkUrl:document.getElementById("banner-link-url").value,order:parseInt(document.getElementById("banner-order").value)||0,isActive:document.getElementById("banner-active").checked};try{await O.save(t,s),u(t?"‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à":"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"),M.closeModal()}catch(n){u(n.message,"error")}}function Se(e){k("‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?",async()=>{try{await O.delete(e),u("‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß")}catch(t){u(t.message,"error")}})}const J={unsubscribe:null,subscribe(e){this.unsubscribe&&this.unsubscribe();const t=d(c("tags"),S("name","asc"));this.unsubscribe=se(t,s=>{const n=s.docs.map(r=>({id:r.id,...r.data()}));e(n)},s=>{console.error("Tags Error:",s),u("‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","error")})},async save(e,t){if(!t.name||!t.slug)throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");e?await C(f(c("tags"),e),t):(t.createdAt=E(),await j(c("tags"),t))},async delete(e){await H(f(c("tags"),e))}},$={renderTable(e,t,s){const n=document.getElementById("tag-table-body");if(n){if(n.innerHTML="",e.length===0){n.innerHTML='<tr><td colspan="3" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</td></tr>';return}e.forEach(r=>{const o=document.createElement("tr");o.className="border-b border-gray-700 hover:bg-gray-800 transition-colors",o.innerHTML=`
                <td class="px-6 py-4 text-white">${r.name}</td>
                <td class="px-6 py-4 text-gray-400 font-mono">${r.slug}</td>
                <td class="px-6 py-4 text-right space-x-2">
                    <button class="btn-edit text-gray-400 hover:text-white" data-id="${r.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn-del text-red-400 hover:text-red-300" data-id="${r.id}"><i class="fas fa-trash"></i></button>
                </td>`,n.appendChild(o)}),n.querySelectorAll(".btn-edit").forEach(r=>{const o=e.find(a=>a.id===r.dataset.id);o&&(r.onclick=()=>t(o))}),n.querySelectorAll(".btn-del").forEach(r=>{r.onclick=()=>s(r.dataset.id)})}},renderCheckboxes(e){const t=document.getElementById("tags-checkbox-container");t&&(t.innerHTML="",e.forEach(s=>{const n=document.createElement("div");n.className="flex items-center space-x-2 p-2 hover:bg-gray-800 rounded",n.innerHTML=`
                <input type="checkbox" id="tag-${s.id}" value="${s.name}" class="show-tag-option form-checkbox h-4 w-4 text-indigo-500 bg-gray-900 border-gray-600 rounded">
                <label for="tag-${s.id}" class="text-sm text-gray-300 cursor-pointer select-none">${s.name}</label>
            `,t.appendChild(n)}))},openModal(e=null){const t=document.getElementById("tag-form");t.reset(),t.dataset.id=e?e.id:"",e?(document.getElementById("tag-name").value=e.name,document.getElementById("tag-slug").value=e.slug,document.getElementById("tag-modal-title").innerText="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"):document.getElementById("tag-modal-title").innerText="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà",document.getElementById("tag-modal").classList.remove("hidden"),document.getElementById("tag-modal").classList.add("flex")},closeModal(){document.getElementById("tag-modal").classList.add("hidden"),document.getElementById("tag-modal").classList.remove("flex")}};function Pe(){var e;J.subscribe(t=>{$.renderTable(t,s=>$.openModal(s),s=>ke(s)),$.renderCheckboxes(t)}),(e=document.getElementById("tag-form"))==null||e.addEventListener("submit",async t=>{t.preventDefault();const s=t.target.dataset.id,n={name:document.getElementById("tag-name").value.trim(),slug:document.getElementById("tag-slug").value.trim()};try{await J.save(s,n),u(s?"‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢":"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"),$.closeModal()}catch(r){u(r.message,"error")}}),window.openTagModal=()=>$.openModal()}function ke(e){k("‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?",async()=>{try{await J.delete(e),u("‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")}catch(t){u(t.message,"error")}})}const oe={cursors:[null],currentPage:1,PER_PAGE:20,resetPagination(){this.currentPage=1,this.cursors=[null]},async fetchList(e="reset"){const t=c("reports"),s=d(t,S("createdAt","desc"));let n;if(e==="reset")this.resetPagination(),n=d(s,h(this.PER_PAGE));else if(e==="next"){const a=this.cursors[this.currentPage];n=a?d(s,I(a),h(this.PER_PAGE)):d(s,h(this.PER_PAGE)),a&&this.currentPage++}else if(e==="prev"){if(this.currentPage>1){this.currentPage--;const a=this.cursors[this.currentPage-1];n=a?d(s,I(a),h(this.PER_PAGE)):d(s,h(this.PER_PAGE))}}else{const a=this.cursors[this.currentPage-1];n=a?d(s,I(a),h(this.PER_PAGE)):d(s,h(this.PER_PAGE))}const r=await v(n);return r.empty&&e!=="reset"&&this.currentPage>1?(this.currentPage--,await this.fetchList("current")):(r.docs.length===this.PER_PAGE&&(this.cursors[this.currentPage]=r.docs[r.docs.length-1]),{items:await Promise.all(r.docs.map(async a=>{const i=a.data();let m="Unknown Show";if(i.showId)try{const l=await R(f(c("shows"),i.showId));l.exists()&&(m=l.data().title)}catch(l){console.warn("Fetch show title error",l)}return{id:a.id,...i,showTitle:m}})),page:this.currentPage,hasNext:r.docs.length===this.PER_PAGE,hasPrev:this.currentPage>1})},async delete(e){await H(f(c("reports"),e))}},G={renderTable(e,t){const s=document.getElementById("report-table-body");if(s){if(s.innerHTML="",e.length===0){s.innerHTML='<tr><td colspan="5" class="text-center py-10 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤</td></tr>';return}e.forEach(n=>{const r=document.createElement("tr");r.className="hover:bg-gray-700/50 border-b border-gray-700/50",r.innerHTML=`
                <td class="px-6 py-4 text-sm text-white">${n.showTitle}</td>
                <td class="px-6 py-4 text-sm text-gray-300">Ep ID: ...${n.episodeId?n.episodeId.slice(-5):"-"}</td>
                <td class="px-6 py-4 text-sm text-rose-400 font-medium">${n.reason||"User Report"}</td>
                <td class="px-6 py-4 text-sm text-gray-400">${K(n.createdAt)}</td>
                <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                    <button class="text-red-400 hover:text-red-300 bg-red-900/20 hover:bg-red-900/40 p-1.5 rounded-md transition-all btn-del-report" data-id="${n.id}"><i class="fas fa-trash"></i></button>
                </td>
            `,s.appendChild(r)}),s.querySelectorAll(".btn-del-report").forEach(n=>{n.addEventListener("click",()=>t(n.dataset.id))})}},renderPagination(e,t,s){const n=document.getElementById("next-page-report"),r=document.getElementById("prev-page-report"),o=document.getElementById("page-info-report");o&&(o.textContent=`‡∏´‡∏ô‡πâ‡∏≤ ${e}`),n&&(n.disabled=!t),r&&(r.disabled=!s)},renderLoading(){const e=document.getElementById("report-table-body");e&&(e.innerHTML='<tr><td colspan="5" class="text-center py-10 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>');const t=document.getElementById("next-page-report"),s=document.getElementById("prev-page-report");t&&(t.disabled=!0),s&&(s.disabled=!0)},renderError(e){const t=document.getElementById("report-table-body");t&&(t.innerHTML=`<tr><td colspan="5" class="text-center py-4 text-red-400">Error: ${e}</td></tr>`)}};function Le(){var e,t,s;(e=document.getElementById("next-page-report"))==null||e.addEventListener("click",()=>fetchReports("next")),(t=document.getElementById("prev-page-report"))==null||t.addEventListener("click",()=>fetchReports("prev")),(s=document.getElementById("btn-refresh-reports"))==null||s.addEventListener("click",()=>fetchReports("reset"))}window.fetchReports=async function(e="reset"){G.renderLoading();try{const t=await oe.fetchList(e);G.renderTable(t.items,s=>Ae(s)),G.renderPagination(t.page,t.hasNext,t.hasPrev)}catch(t){console.error(t),G.renderError(t.message)}};function Ae(e){k("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?",async()=>{try{await oe.delete(e),u("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"),window.fetchReports("current"),window.fetchDashboardStats&&window.fetchDashboardStats()}catch(t){u(t.message,"error")}})}const $e="tianchai4744@gmail.com";de("silent");let V=!1;const ee={async fetchStats(){const[e,t,s]=await Promise.all([U(c("shows")),U(c("episodes")),U(c("reports"))]);return{shows:e.data().count,episodes:t.data().count,reports:s.data().count}},async fetchRecentActivity(){const e=d(c("shows"),S("updatedAt","desc"),h(5));return(await v(e)).docs.map(s=>({id:s.id,...s.data()}))}},T={epChart:null,tagChart:null,updateStats(e){this._setText("stat-total-shows",e.shows),this._setText("stat-total-episodes",e.episodes),this._setText("stat-total-reports",e.reports),this.updateBadges(e.reports)},updateBadges(e){const t=document.getElementById("sidebar-report-badge"),s=document.getElementById("dashboard-report-badge");t&&(t.innerText=e,t.classList.toggle("hidden",e===0),t.classList.toggle("badge-pulse",e>0)),s&&(s.innerText=`${e} New!`,s.classList.toggle("hidden",e===0))},renderRecentActivity(e){const t=document.getElementById("recent-activity-list");if(t){if(e.length===0){t.innerHTML='<p class="text-slate-500 text-sm text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</p>';return}t.innerHTML=e.map(s=>`
            <div class="flex items-center space-x-3 p-2 hover:bg-slate-700/50 rounded-lg transition-colors cursor-pointer" onclick="openShowModal('${s.id}')">
                <img src="${s.thumbnailUrl}" class="w-10 h-14 rounded object-cover bg-slate-800" onerror="this.src='https://placehold.co/40x60'">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">${s.title}</p>
                    <p class="text-xs text-slate-400">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${K(s.updatedAt)}</p>
                </div>
                <div class="text-xs text-indigo-400 font-bold bg-indigo-400/10 px-2 py-1 rounded">
                    Ep.${s.latestEpisodeNumber||0}
                </div>
            </div>
        `).join("")}},renderCharts(){if(typeof window.Chart>"u")return;const e=document.getElementById("chart-episodes");e&&(this.epChart&&this.epChart.destroy(),this.epChart=new window.Chart(e,{type:"line",data:{labels:["‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå","‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"],datasets:[{label:"‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà",data:[12,19,3,5,2,3,10],borderColor:"#6366f1",backgroundColor:"rgba(99, 102, 241, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#6366f1"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{grid:{color:"rgba(255,255,255,0.05)"},ticks:{color:"#94a3b8"},border:{display:!1}},x:{grid:{display:!1},ticks:{color:"#94a3b8"},border:{display:!1}}}}}));const t=document.getElementById("chart-tags");t&&(this.tagChart&&this.tagChart.destroy(),this.tagChart=new window.Chart(t,{type:"doughnut",data:{labels:["Action","Romance","Fantasy","Isekai","Drama"],datasets:[{data:[35,20,25,15,5],backgroundColor:["#6366f1","#ec4899","#10b981","#f59e0b","#3b82f6"],borderWidth:0,hoverOffset:10}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"75%",plugins:{legend:{position:"right",labels:{color:"#cbd5e1",padding:20,usePointStyle:!0}}}}}))},showLoginOverlay(){if(document.getElementById("admin-login-overlay"))return;const e=document.createElement("div");e.id="admin-login-overlay",e.className="fixed inset-0 bg-[#0f172a] z-[9999] flex flex-col items-center justify-center p-4",e.innerHTML=`
            <div class="bg-[#1e293b] p-8 rounded-3xl shadow-2xl border border-slate-700 max-w-sm w-full text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">ANI-END Admin</h1>
                <p class="text-slate-400 mb-8 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</p>
                <button id="btn-admin-login" class="w-full flex items-center justify-center gap-3 bg-white hover:bg-slate-100 text-slate-900 font-bold py-3.5 px-6 rounded-xl transition-all transform hover:-translate-y-1 shadow-lg">
                    <i class="ri-google-fill text-xl text-rose-600"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
                </button>
                <p class="mt-8 text-xs text-slate-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            </div>`,document.body.appendChild(e),document.getElementById("btn-admin-login").onclick=async()=>{try{const t=new ue;await me(F,t)}catch(t){u("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: "+t.message,"error")}}},removeLoginOverlay(){var e;(e=document.getElementById("admin-login-overlay"))==null||e.remove()},_setText(e,t){const s=document.getElementById(e);s&&(s.innerText=t)}};window.switchTab=function(e){var t;["dashboard","shows","episodes","banners","reports","tags"].forEach(s=>{const n=document.getElementById(s+"-panel");n&&(s===e?n.classList.remove("hidden"):n.classList.add("hidden"))}),document.querySelectorAll(".nav-item").forEach(s=>s.classList.remove("active","text-indigo-400","bg-slate-800")),(t=document.getElementById("tab-"+e))==null||t.classList.add("active"),e==="dashboard"&&W(),e==="reports"&&window.fetchReports&&window.fetchReports("reset")};async function W(){try{const e=await ee.fetchStats();T.updateStats(e),T.renderCharts();const t=await ee.fetchRecentActivity();T.renderRecentActivity(t)}catch(e){console.error(e)}}window.fetchDashboardStats=W;ce(F,async e=>{if(!V)if(e){if(e.email===$e){z(e);return}try{if((await e.getIdTokenResult()).claims.role==="admin"){z(e);return}const s=await R(f(N,`artifacts/${le}/users/${e.uid}`));s.exists()&&s.data().role==="admin"?z(e):te()}catch(t){console.error("Admin check error:",t),te()}}else T.showLoginOverlay()});function z(e){if(V)return;V=!0,console.log("Admin Access Granted:",e.email),T.removeLoginOverlay(),W(),ge(),we(),Ie(),Pe(),Le(),setInterval(W,6e4);const t=document.getElementById("btn-logout");if(t){const s=t.cloneNode(!0);t.parentNode.replaceChild(s,t),s.addEventListener("click",()=>{k("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö","‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?",async()=>{await ne(F),window.location.reload()})})}switchTab("dashboard")}async function te(){u("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ","error"),await ne(F),setTimeout(()=>{window.location.href="/"},1500)}
