<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANI-END - กำลังโหลด...</title>
    <meta name="description" content="ดูอนิเมะออนไลน์ อนิเมะจีน อนิเมะพากย์ไทย อัปเดตตอนใหม่ทุกวัน">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
    <style>
        body { background-color: #111; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .video-aspect-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background-color: #000; }
        #video-player-embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; display: flex; align-items: center; justify-content: center; }
        #video-player-embed iframe { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }
        .ep-button.active { background-color: #16a34a !important; color: #fff !important; pointer-events: none; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Top 10 Styles */
        .rank-badge-lg { display: flex; align-items: center; justify-content: center; background-clip: text; -webkit-background-clip: text; }
    </style>
</head>
<body class="bg-black text-gray-100"> 
    
    <div id="navbar-placeholder"></div>

<script type="module">
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { doc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { db, auth, appId } from "../js/config/db-config.js";
    
    // Core Modules
    import { loadNavbar } from "../js/modules/navbar.js";
    import { setupSearchSystem } from "../js/modules/search.js";
    
    // Player Modules (Refactored)
    import { setupPlayerInfo, embedEpisode, updatePlayerMetadata } from "../js/modules/player-core.js";
    import { initEpisodeList, loadEpisodesByRange, highlightActiveEpisode, findNextPrevEpisode, syncRangeSelector } from "../js/modules/episode-list.js";
    import { initBookmarkSystem } from "../js/modules/bookmark-manager.js";
    import { trackView, saveHistory, loadWatchHistory } from "../js/modules/watch-service.js";
    import { initReportSystem, updateReportUI } from "../js/modules/report-service.js";
    import { renderRelatedAnime } from "../js/modules/player-related.js";
    import { renderPlayerTop10 } from "../js/modules/player-top10.js";
    import { initCommentSystem, postComment, updateCommentUIState } from "../js/modules/comments.js";

    // Global State
    let currentUser = null;
    let currentShow = null;
    let currentEpisode = null;
    let historyItems = []; 
    let isSearchInitialized = false;
    const EPISODES_PER_BATCH = 50;

    // Orchestrator Function: จัดการเมื่อมีการเล่นตอน
    async function playEpisode(episode) {
        if (!episode) return;
        currentEpisode = episode;
        
        // 1. Core Player
        embedEpisode(episode);
        updatePlayerMetadata(currentShow, episode);
        
        // 2. Services
        if (currentUser) saveHistory(currentUser.uid, currentShow, episode);
        trackView(currentShow.id);
        
        // 3. UI Updates
        highlightActiveEpisode(episode.id);
        syncRangeSelector(episode.number); 
        updateReportUI(episode);
        updateNavButtons(episode.number);
        
        // 4. Comments
        initCommentSystem(currentShow.id, episode.id, episode.number);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateNavButtons(currentNum) {
        const prevBtn = document.getElementById('prev-episode-btn');
        const nextBtn = document.getElementById('next-episode-btn');
        const maxEp = currentShow.latestEpisodeNumber || 9999;
        
        if(prevBtn) prevBtn.disabled = (currentNum <= 1);
        if(nextBtn) nextBtn.disabled = (currentNum >= maxEp);
    }

    // Navigation Handler
    async function navigateEpisode(direction) {
        if (!currentEpisode) return;
        
        const btn = direction === 'next' ? document.getElementById('next-episode-btn') : document.getElementById('prev-episode-btn');
        btn.disabled = true; 

        try {
            const nextEp = await findNextPrevEpisode(currentEpisode.number, direction, currentShow);
            
            if (nextEp) {
                // ตรวจสอบว่าข้ามช่วงตอนหรือไม่ ถ้าข้ามต้องโหลดใหม่
                const currentRangeStart = Math.floor((currentEpisode.number - 1) / EPISODES_PER_BATCH) * EPISODES_PER_BATCH + 1;
                const nextRangeStart = Math.floor((nextEp.number - 1) / EPISODES_PER_BATCH) * EPISODES_PER_BATCH + 1;
                
                if (currentRangeStart !== nextRangeStart) {
                     const end = nextRangeStart + EPISODES_PER_BATCH - 1;
                     await loadEpisodesByRange(nextRangeStart, end, document.getElementById('episode-list-container'), playEpisode);
                }
                
                playEpisode(nextEp);
            }
        } catch(e) { console.error(e); }
        finally { btn.disabled = false; }
    }

    // Main Init
    document.addEventListener('DOMContentLoaded', async () => {
        setLogLevel('silent');
        await loadNavbar('..');
        
        // Get Elements
        const loadingPlayer = document.getElementById('loading-player');
        const playerContent = document.getElementById('player-content-wrapper');
        
        // Event Bindings
        document.getElementById('prev-episode-btn').onclick = () => navigateEpisode('prev');
        document.getElementById('next-episode-btn').onclick = () => navigateEpisode('next');
        document.getElementById('btn-post-comment')?.addEventListener('click', () => postComment(currentUser));

        // Auth & Data Loading
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            updateCommentUIState(user);
            
            const urlParams = new URLSearchParams(window.location.search);
            const showId = urlParams.get('id');
            const epIdFromUrl = urlParams.get('ep_id');

            if (!showId) {
                loadingPlayer.innerHTML = '<p class="text-red-500">URL ไม่ถูกต้อง</p>';
                return;
            }

            try {
                // 1. Fetch Show Data
                const showSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/shows`, showId));
                if (!showSnap.exists()) throw new Error("ไม่พบข้อมูลอนิเมะ");
                currentShow = { id: showSnap.id, ...showSnap.data() };

                // 2. Setup Player Core Info
                setupPlayerInfo(currentShow);
                
                // 3. Load User Data (History, Bookmarks)
                if (user) {
                    historyItems = await loadWatchHistory(user.uid);
                    if (!isSearchInitialized) { setupSearchSystem(historyItems); isSearchInitialized = true; }
                } else {
                    if (!isSearchInitialized) { setupSearchSystem([]); isSearchInitialized = true; }
                }

                // 4. Determine Episode to Play
                // Priority: URL -> History -> First Episode
                let targetEpId = epIdFromUrl;
                let targetEpNum = 1;

                if (!targetEpId && historyItems.length > 0) {
                    const history = historyItems.find(h => h.showId === showId);
                    if (history) targetEpId = history.lastWatchedEpisodeId;
                }

                // 5. Initialize Modules
                initBookmarkSystem(user, currentShow);
                initReportSystem(user, currentShow, () => currentEpisode); 
                renderRelatedAnime(currentShow, historyItems);
                renderPlayerTop10(historyItems);

                // 6. Initialize Episode List & Play
                if (targetEpId) {
                    const epSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/episodes`, targetEpId));
                    if (epSnap.exists()) {
                        const epData = { id: epSnap.id, ...epSnap.data() };
                        targetEpNum = epData.number;
                        
                        await initEpisodeList(showId, currentShow.latestEpisodeNumber, playEpisode);
                        
                        // Load Specific Range
                        const rangeStart = Math.floor((targetEpNum - 1) / EPISODES_PER_BATCH) * EPISODES_PER_BATCH + 1;
                        const rangeEnd = rangeStart + EPISODES_PER_BATCH - 1;
                        
                        await loadEpisodesByRange(rangeStart, rangeEnd, document.getElementById('episode-list-container'), playEpisode);
                        playEpisode(epData);
                    } else {
                        // Fallback if episode deleted
                         await initEpisodeList(showId, currentShow.latestEpisodeNumber, playEpisode);
                         await loadEpisodesByRange(1, EPISODES_PER_BATCH, document.getElementById('episode-list-container'), playEpisode);
                    }
                } else {
                    // Default Case (No history, no url param)
                    await initEpisodeList(showId, currentShow.latestEpisodeNumber, playEpisode);
                    const episodes = await loadEpisodesByRange(1, EPISODES_PER_BATCH, document.getElementById('episode-list-container'), playEpisode);
                    if (episodes.length > 0) playEpisode(episodes[0]);
                    else embedEpisode(null);
                }

                // Reveal UI
                loadingPlayer.classList.add('hidden');
                playerContent.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                loadingPlayer.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาด: ${error.message}</p>`;
            }
        });

        // Browser Back Button Support
        window.addEventListener('popstate', () => window.location.reload());
    });
</script>

    <div id="loading-player" class="flex items-center justify-center" style="min-height: 80vh;"><p class="text-2xl text-gray-400">กำลังโหลดเนื้อหา...</p></div>
    
    <div id="player-content-wrapper" class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 hidden">
        
        <div id="broken-alert" class="hidden bg-red-800/80 border border-red-700 text-white p-3 rounded-lg mb-4 text-sm font-medium items-center">
            <i class="ri-error-warning-line mr-2"></i> วิดีโอนี้ถูกระบุว่ามีปัญหาโดยระบบ กำลังรอการแก้ไขโดยผู้ดูแลระบบ.
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
            
            <div class="lg:col-span-2 w-full order-1">
                <div class="video-aspect-wrapper rounded-lg overflow-hidden relative z-10 shadow-lg bg-gray-900"> 
                    <div id="video-player-embed"></div>
                </div>
                
                <div class="flex justify-between items-center mt-4 bg-gray-900/50 p-2 rounded-lg backdrop-blur-sm"> 
                    <button id="prev-episode-btn" class="flex items-center bg-gray-700 hover:bg-green-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-700">
                        <i class="ri-arrow-left-s-line mr-1"></i> ตอนก่อนหน้า
                    </button>
                    <button id="report-broken-btn" class="flex items-center bg-gray-700 hover:bg-red-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ri-error-warning-line mr-1"></i> แจ้ง (เสีย)
                    </button>
                    <button id="next-episode-btn" class="flex items-center bg-gray-700 hover:bg-green-600 text-white text-sm font-medium py-1.5 px-3 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-700">
                        ตอนถัดไป <i class="ri-arrow-right-s-line ml-1"></i>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1 w-full order-3 lg:order-2">
                <section class="bg-gray-900 rounded-lg p-4 border border-gray-800 shadow-lg h-full"> 
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-bold text-white flex items-center"><i class="ri-list-check mr-2 text-green-500"></i> เลือกตอน</h3>
                        <div id="episode-range-container" class="hidden">
                            <select id="episode-range-select" class="bg-gray-800 text-white text-xs rounded px-2 py-1 outline-none border border-gray-600 focus:border-green-500 cursor-pointer hover:bg-gray-700 transition-colors">
                            </select>
                        </div>
                    </div>
                    
                    <div id="episode-list-container" class="flex flex-wrap gap-2 max-h-[400px] lg:max-h-[500px] overflow-y-auto content-start custom-scrollbar">
                        <p class="text-gray-400">กำลังโหลด...</p>
                    </div>
                </section>
            </div>

            <div class="contents lg:flex lg:flex-col lg:col-span-2 lg:order-3 lg:gap-4">
                
                <div class="order-2 w-full">
                    <div class="text-white p-5 bg-gray-900 rounded-lg shadow-lg border border-gray-800"> 
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1">
                                 <h1 id="show-title" class="text-2xl font-bold mb-2 leading-tight">...</h1>
                            </div>
                            <button id="btn-bookmark" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-full border border-gray-600 text-sm hover:bg-gray-800 transition-colors text-gray-400">
                                <i class="ri-heart-line"></i> เพิ่มรายการโปรด
                            </button>
                        </div>
                        <p id="show-description" class="text-gray-300 line-clamp-2 mt-3 text-sm leading-relaxed">...</p>
                        <button id="expand-desc-btn" class="text-green-400 text-sm mt-1 hidden hover:underline">เพิ่มเติม</button>
                    </div>
                </div>

                <div class="order-5 w-full">
                    <section class="bg-gray-900 rounded-lg p-5 border border-gray-800 shadow-lg"> 
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-3 flex items-center">
                            <i class="ri-film-line mr-2 text-green-500"></i> อนิเมะแนะนำ
                        </h3>
                        <div id="related-list-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                    </section>
                </div>

                <div class="order-6 w-full">
                    <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-800 shadow-lg">
                        <div class="flex items-center border-b border-gray-800 bg-gray-900">
                            <button id="tab-comment-episode" class="flex-1 py-3 text-sm font-bold text-white border-b-2 border-green-500 bg-gray-800/50 transition-all">
                                <i class="ri-movie-2-line mr-1"></i> พูดคุยตอนนี้
                            </button>
                            <button id="tab-comment-show" class="flex-1 py-3 text-sm font-medium text-gray-400 border-b border-gray-700 hover:text-white hover:bg-gray-800 transition-all">
                                <i class="ri-discuss-line mr-1"></i> พูดคุยทั้งเรื่อง
                            </button>
                        </div>
                        
                        <div class="p-4 sm:p-6">
                            <div id="comment-input-area" class="flex gap-3 mb-6 hidden animate-fade-in">
                                <img id="comment-user-avatar" src="" class="w-10 h-10 rounded-full border border-gray-600 shadow-sm">
                                <div class="flex-1">
                                    <div class="relative">
                                        <textarea id="comment-input" rows="2" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500/50 transition-all text-sm resize-none" placeholder="แสดงความคิดเห็นของคุณ..."></textarea>
                                        <div class="absolute bottom-2 right-2">
                                            <i class="ri-chat-smile-2-line text-gray-500"></i>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs text-gray-500"><i class="ri-information-line"></i> โปรดใช้คำสุภาพ</span>
                                        <button id="btn-post-comment" class="bg-green-600 hover:bg-green-500 text-white px-5 py-1.5 rounded-full font-bold text-xs transition-transform transform active:scale-95 shadow-lg shadow-green-900/20">
                                            โพสต์
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="comment-login-prompt" class="bg-gray-800/50 rounded-lg p-6 text-center border border-dashed border-gray-700 mb-6">
                                <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="ri-lock-2-line text-xl text-gray-400"></i>
                                </div>
                                <p class="text-gray-300 font-medium text-sm">เข้าสู่ระบบเพื่อร่วมพูดคุย</p>
                                <button onclick="window.triggerLogin()" class="mt-3 bg-white text-gray-900 px-6 py-2 rounded-full text-xs font-bold hover:bg-gray-100 transition-colors shadow-md">
                                    เข้าสู่ระบบ / สมัครสมาชิก
                                </button>
                            </div>
                            
                            <div id="comments-list" class="space-y-2 min-h-[200px]"></div>
                            <button id="btn-load-more-comments" class="hidden w-full py-2 text-sm text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg mt-2 transition-colors">
                                โหลดความคิดเห็นเพิ่มเติม...
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 w-full order-4">
                <section class="bg-gray-900 rounded-lg p-4 border border-gray-800 shadow-lg sticky top-20"> 
                    <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-3 flex items-center">
                        <i class="ri-fire-line mr-2 text-orange-500"></i> 10 อันดับยอดนิยม
                    </h3>
                    <div id="top10-list-container" class="flex flex-col space-y-1"></div>
                </section>
            </div>

        </div>
    </div>
</body>
</html>
