<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ANI-END - เว็บไซต์ดูอนิเมะออนไลน์ รวบรวมอนิเมะจีน อนิเมะพากย์ไทย และอนิเมะยอดนิยม อัปเดตตอนใหม่ทุกวัน">
    <title>ANI-END - รายการอนิเมะและผลการค้นหา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4B5563; }
        body { background-color: #111; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        main { flex: 1; }
        #grid-view-title { scroll-margin-top: 80px; }
        .scroll-to-top { transition: all 0.3s; visibility: hidden; opacity: 0; transform: translateY(20px); }
        .scroll-to-top.visible { visibility: visible; opacity: 1; transform: translateY(0); }
        
        /* Skeleton */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .skeleton {
            background-color: #374151;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-black text-gray-100">

    <div id="navbar-placeholder"></div>

    <script type="module">
        import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { onSnapshot, collection, query, limit, orderBy, where, getDocs, startAfter, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { db, auth, appId } from "../js/config/firebase.js";
        import { createAnimeCard } from "../js/modules/card.js";
        import { setupSearchSystem } from "../js/modules/search.js";
        import { loadNavbar } from "../js/modules/navbar.js";
        import { generateSearchTerms } from "../js/utils/common.js"; 

        const ITEMS_PER_PAGE = 28; 
        let userId;
        let currentMode = 'tag'; 
        
        // ตัวแปรสำหรับจัดการข้อมูล
        let currentTag = ''; 
        let lastTagDoc = null; 
        
        // Search Variables
        let activeSearchQueries = []; 
        let searchCursors = {}; 
        let finishedQueries = new Set();
        
        // Deduplication Set (เก็บ ID ที่โหลดมาแล้ว)
        let loadedShowIds = new Set();
        
        let isFetching = false;
        let hasMoreData = true;
        let historyItems = []; 
        let isSearchInitialized = false; 
        
        let gridViewContainer, gridViewTitle, gridViewContent, loadMoreBtn;
        let scrollToTopBtn;
        
        async function initializeFirebase() {
            setLogLevel('silent');
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await loadHistory(); 
                    if (!isSearchInitialized) {
                        setupSearchSystem(historyItems);
                        isSearchInitialized = true;
                    }
                    setupPageFromUrl(); 
                } else {
                    await signInAnonymously(auth);
                }
            });
        }

        function getCollectionRef(collectionName) {
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        }

        async function loadHistory() {
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/viewHistory`), orderBy("watchedAt", "desc"), limit(50));
                const snap = await getDocs(q);
                historyItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) { console.error("History Error", e); }
        }

        function setupPageFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchFromUrl = urlParams.get('search'); 
            const tagFromUrl = urlParams.get('tag');

            // Reset States
            lastTagDoc = null;
            searchCursors = {};
            finishedQueries.clear();
            activeSearchQueries = [];
            hasMoreData = true;
            loadedShowIds.clear(); 
            
            gridViewContent.innerHTML = '';
            loadMoreBtn.classList.add('hidden');

            if (searchFromUrl) {
                const queryStr = decodeURIComponent(searchFromUrl);
                currentMode = 'search';
                
                // ใช้ Logic กลางจาก utils.js
                activeSearchQueries = generateSearchTerms(queryStr);
                
                gridViewTitle.textContent = `ผลการค้นหา "${queryStr}"`;
                document.title = `ค้นหา: ${queryStr} | ANI-END`;
                
                const searchInput = document.getElementById('search-input');
                const mobileSearchInput = document.getElementById('mobile-search-input');
                if (searchInput) searchInput.value = queryStr;
                if (mobileSearchInput) mobileSearchInput.value = queryStr;

                fetchDataBatch(); 

            } else {
                const tag = tagFromUrl ? decodeURIComponent(tagFromUrl) : 'อนิเมะ';
                currentMode = 'tag';
                currentTag = tag;
                
                gridViewTitle.textContent = tag;
                document.title = `${tag} | ANI-END`;
                
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';

                fetchDataBatch(); 
            }
        }

        // --- SKELETON GENERATOR ---
        function generateSkeletons(count = 14) {
            let html = '';
            for(let i=0; i<count; i++) {
                html += `
                <div class="block rounded-lg overflow-hidden relative">
                    <div class="aspect-[2/3] bg-gray-800 skeleton w-full h-full rounded-lg mb-2"></div>
                    <div class="h-4 bg-gray-800 skeleton w-3/4 rounded mb-1"></div>
                </div>`;
            }
            return html;
        }

        async function fetchDataBatch() {
            if (isFetching || !hasMoreData) return;
            isFetching = true;
            
            const isFirstLoad = loadedShowIds.size === 0;

            if (isFirstLoad) {
                // [NEW] แสดง Skeleton
                gridViewContent.innerHTML = generateSkeletons(14);
            } else {
                loadMoreBtn.textContent = 'กำลังโหลด...';
                loadMoreBtn.disabled = true;
            }

            try {
                const colRef = getCollectionRef("shows");
                let incomingDocs = [];

                if (currentMode === 'search') {
                    // --- Multi-Query Parallel Fetch (Search Logic) ---
                    const promises = activeSearchQueries.map(async (qStr) => {
                        if (finishedQueries.has(qStr)) return []; 

                        // [แก้ไข] เปลี่ยน Query ให้ค้นหาจาก keywords (array-contains) และเอา orderBy ออก
                        let q = query(
                            colRef, 
                            where("keywords", "array-contains", qStr),
                            limit(ITEMS_PER_PAGE)
                        );

                        if (searchCursors[qStr]) {
                            q = query(q, startAfter(searchCursors[qStr]));
                        }

                        const snapshot = await getDocs(q);
                        
                        if (!snapshot.empty) {
                            searchCursors[qStr] = snapshot.docs[snapshot.docs.length - 1]; 
                            if (snapshot.docs.length < ITEMS_PER_PAGE) {
                                finishedQueries.add(qStr); 
                            }
                            return snapshot.docs;
                        } else {
                            finishedQueries.add(qStr);
                            return [];
                        }
                    });

                    const resultsArrays = await Promise.all(promises);
                    incomingDocs = resultsArrays.flat();

                    if (finishedQueries.size === activeSearchQueries.length) {
                        hasMoreData = false;
                    }

                } else {
                    // --- Single Query (Tag) ---
                    let q = query(
                        colRef, 
                        where("tags", "array-contains", currentTag), 
                        orderBy("updatedAt", "desc"), 
                        limit(ITEMS_PER_PAGE)
                    );

                    if (lastTagDoc) {
                        q = query(q, startAfter(lastTagDoc));
                    }

                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) {
                        incomingDocs = snapshot.docs;
                        lastTagDoc = snapshot.docs[snapshot.docs.length - 1];
                        if (snapshot.docs.length < ITEMS_PER_PAGE) hasMoreData = false;
                    } else {
                        hasMoreData = false;
                    }
                }

                // --- Deduplication & Rendering ---
                if (isFirstLoad) gridViewContent.innerHTML = '';

                const uniqueNewDocs = [];
                incomingDocs.forEach(doc => {
                    if (!loadedShowIds.has(doc.id)) {
                        loadedShowIds.add(doc.id);
                        uniqueNewDocs.push(doc);
                    }
                });

                if (uniqueNewDocs.length > 0) {
                    // เรียงลำดับเฉพาะใน Batch ปัจจุบัน
                    if (currentMode === 'search') {
                        uniqueNewDocs.sort((a, b) => (a.data().title || '').localeCompare(b.data().title || ''));
                    }

                    let html = '';
                    uniqueNewDocs.forEach((doc, index) => {
                        // ส่ง null เพื่อไม่แสดง Rank
                        html += createAnimeCard({ id: doc.id, ...doc.data() }, null, historyItems.find(h => h.showId === doc.id));
                    });

                    gridViewContent.insertAdjacentHTML('beforeend', html);
                    
                    if (hasMoreData) {
                        loadMoreBtn.classList.remove('hidden');
                        loadMoreBtn.textContent = 'โหลดเพิ่มเติม...';
                        loadMoreBtn.disabled = false;
                    } else {
                        loadMoreBtn.classList.add('hidden');
                    }
                } else {
                    if (isFirstLoad) {
                        const msg = currentMode === 'search' ? `ไม่พบผลลัพธ์การค้นหา` : `ไม่พบข้อมูลในหมวดนี้`;
                        gridViewContent.innerHTML = `<p class="text-center w-full col-span-full text-gray-400 py-10">${msg}</p>`;
                    }
                    if (!hasMoreData) loadMoreBtn.classList.add('hidden');
                    
                    if (hasMoreData && uniqueNewDocs.length === 0) {
                         isFetching = false;
                         fetchDataBatch();
                         return;
                    }
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                const isIndexError = error.message.includes("index");
                if (isFirstLoad) {
                    if (isIndexError) {
                         const indexLink = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                         const linkHtml = indexLink ? `<a href="${indexLink[0]}" target="_blank" class="text-yellow-400 underline block mt-2">คลิกเพื่อสร้าง Index</a>` : '';
                         gridViewContent.innerHTML = `<div class="col-span-full text-center p-6 border border-yellow-600 bg-yellow-900/20 text-yellow-500">ระบบต้องการ Index สำหรับการค้นหานี้ ${linkHtml}</div>`;
                    } else {
                         gridViewContent.innerHTML = `<p class="text-center w-full col-span-full text-red-500">เกิดข้อผิดพลาดในการโหลด</p>`;
                    }
                }
            } finally { 
                isFetching = false;
                if (hasMoreData && loadMoreBtn) {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'โหลดเพิ่มเติม...';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadNavbar('..');

            gridViewContainer = document.getElementById('grid-view-container');
            gridViewTitle = document.getElementById('grid-view-title');
            gridViewContent = document.getElementById('grid-view-content');
            loadMoreBtn = document.getElementById('load-more-btn');

            scrollToTopBtn = document.createElement('button');
            scrollToTopBtn.innerHTML = '<i class="ri-arrow-up-line text-2xl"></i>';
            scrollToTopBtn.className = 'scroll-to-top fixed bottom-8 right-8 bg-green-600 text-white p-3 rounded-full shadow-lg cursor-pointer hover:bg-green-700 z-50';
            scrollToTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            document.body.appendChild(scrollToTopBtn);
            window.addEventListener('scroll', () => scrollToTopBtn.classList.toggle('visible', window.scrollY > 300));

            window.addEventListener('popstate', setupPageFromUrl);
            
            if (loadMoreBtn) loadMoreBtn.addEventListener('click', fetchDataBatch);

            initializeFirebase();
        });
    </script>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div id="grid-view-container">
            <h2 id="grid-view-title" class="text-3xl font-bold mb-6">...</h2>
            <div id="grid-view-content" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-4 min-h-[300px]"></div>
            <div class="text-center mt-8">
                <button id="load-more-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 hidden">โหลดเพิ่มเติม...</button>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 border-t border-gray-800 mt-8 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm mb-2">© 2024 ANI-END. All rights reserved.</p>
            <p class="text-gray-500 text-xs">เว็บไซต์นี้จัดทำขึ้นเพื่อการศึกษาและการเรียนรู้เท่านั้น</p>
        </div>
    </footer>
</body>
</html>

